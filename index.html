<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–°æ€æƒ³å­¦ä¹ ç¤¾</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{background:#b81c1c;color:#fff;font-family:sans-serif;line-height:1.6;height:100vh;}
.splash-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999999;animation:splashFade 2.5s ease forwards;animation-delay:3s;}
.ntlc-logo{display:flex;gap:12px;font-size:80px;font-weight:900;margin-bottom:40px;}
.ntlc-letter{opacity:0;transform:scale(0.5);animation:letterPop 0.6s ease forwards;}
.ntlc-letter:nth-child(1){color:#4285F4;animation-delay:0.2s;}
.ntlc-letter:nth-child(2){color:#EA4335;animation-delay:0.4s;}
.ntlc-letter:nth-child(3){color:#FBBC05;animation-delay:0.6s;}
.ntlc-letter:nth-child(4){color:#34A853;animation-delay:0.8s;}
@keyframes letterPop{0%{opacity:0;transform:scale(0.5);}70%{opacity:1;transform:scale(1.1);}100%{opacity:1;transform:scale(1);}}
@keyframes splashFade{0%{opacity:1;}100%{opacity:0;visibility:hidden;}}

.auth-modal,.pwd-modal,.reject-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(80,0,0,0.8);z-index:9999;display:none;align-items:center;justify-content:center;animation:fadeIn 0.3s forwards;}
@keyframes fadeIn{0%{opacity:0;}100%{opacity:1;}}
.modal-close{position:absolute;top:15px;right:15px;font-size:24px;color:#ffd700;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;cursor:pointer;}
.auth-box,.pwd-box,.reject-box{background:#801010;padding:30px;border-radius:12px;width:90%;max-width:420px;animation:popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) forwards;transform:scale(0);}
@keyframes popIn{0%{transform:scale(0);}70%{transform:scale(1.05);}100%{transform:scale(1);}}
.auth-tabs{display:flex;gap:10px;margin-bottom:20px;}
.auth-tab{flex:1;padding:12px;text-align:center;background:rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;}
.auth-tab.active{background:#ffd700;color:#5a0000;font-weight:bold;}
.auth-input,.pwd-input,.reject-reason{width:100%;padding:14px;margin-bottom:12px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,215,0,0.4);outline:none;}
.reject-reason{height:100px;resize:none;}
.auth-btn,.pwd-btn,.reject-btn{width:100%;padding:14px;border-radius:8px;background:#ffd700;color:#5a0000;font-weight:bold;border:none;cursor:pointer;}
.cancel-login{width:100%;margin-top:10px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.1);color:#ffd700;border:1px solid #ffd700;cursor:pointer;}

.main-app{display:none;}
.user-bar{background:#801010;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;}
.user-info{display:flex;align-items:center;gap:8px;}
.avatar{width:32px;height:32px;border-radius:50%;border:2px solid #ffd700;}
.user-name{color:#ffd700;font-weight:bold;}
.logout{color:#fff;cursor:pointer;}

.search-bar{background:#801010;padding:8px 15px;text-align:center;}
.search-input{width:90%;max-width:400px;padding:10px 14px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #ffd70066;outline:none;}

.navbar{background:#801010;padding:12px 10px;text-align:center;border-bottom:1px solid #ffd70033;}
.navbar h1{color:#fff;font-size:28px;margin-bottom:15px;}
.nav-links-first{display:flex;justify-content:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
.nav-links-second{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;}
.nav-link{color:#fff;padding:8px 16px;border-radius:8px;cursor:pointer;transition:0.2s;font-size:16px;}
.nav-link.active{background:#ffd700;color:#801010;font-weight:bold;}

.container{max-width:800px;margin:0 auto;padding:15px 10px;}
.card{background:#801010;padding:20px;border-radius:12px;margin-bottom:15px;}
.card h3{color:#ffd700;text-align:center;margin-bottom:15px;}

.member-only{display:none;}
.has-account .member-only{display:inline-block;}

.article-item{padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:10px;}
.article-title{color:#ffd700;font-weight:bold;font-size:17px;}
.article-meta{font-size:12px;color:#ccc;margin:4px 0;}
.article-content{color:#eee;font-size:15px;line-height:1.7;}

.btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:bold;margin-right:4px;}
.btn-sm{padding:4px 8px;font-size:12px;}
.btn-green{background:#28a050;color:#fff;}
.btn-red{background:#c81010;color:#fff;}
.btn-yellow{background:#ffc107;color:#222;}

.chat-layout{display:grid;grid-template-columns:200px 1fr;gap:12px;margin-top:10px;}
.chat-user-list{height:420px;overflow-y:auto;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;}
.chat-user-item{padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer;}
.chat-user-item:hover,.chat-user-item.active{background:rgba(255,215,0,0.15);}
.chat-user-name{color:#ffd700;font-weight:bold;font-size:14px;}
.unread-tag{background:red;color:#fff;font-size:10px;padding:1px 4px;border-radius:4px;margin-left:4px;}
.chat-box{height:420px;display:flex;flex-direction:column;gap:8px;}
.msg-area{flex:1;background:rgba(0,0,0,0.15);border-radius:8px;padding:10px;overflow-y:auto;}
.msg-input-area{display:flex;gap:6px;}
.msg-input{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #ffd70055;}
.send-btn{padding:0 16px;background:#ffd700;color:#801010;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
.msg-item{max-width:75%;margin-bottom:10px;padding:8px 12px;border-radius:12px;line-height:1.4;}
.msg-me{margin-left:auto;background:#ffd700;color:#5a0000;border-bottom-right-radius:4px;}
.msg-other{margin-right:auto;background:rgba(255,255,255,0.1);color:#fff;border-bottom-left-radius:4px;}
.msg-status{font-size:10px;color:#ccc;text-align:right;margin-top:2px;}

.meeting-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
.meeting-controls{display:flex;gap:8px;}
.meeting-btn{padding:8px 14px;border-radius:6px;border:none;cursor:pointer;}
.meeting-btn.primary{background:#ffd700;color:#5a0000;}
.meeting-btn.secondary{background:rgba(255,255,255,0.1);color:#fff;}
.participant-list{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.participant{background:rgba(255,255,255,0.07);padding:10px;border-radius:8px;text-align:center;}
.part-avatar{width:40px;height:40px;border-radius:50%;background:#ffd700;color:#5a0000;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-weight:bold;}
</style>
</head>
<body>

<div class="splash-screen">
  <div class="ntlc-logo">
    <span class="ntlc-letter">N</span><span class="ntlc-letter">T</span><span class="ntlc-letter">L</span><span class="ntlc-letter">C</span>
  </div>
  <p style="color:#666;">æ–°æ€æƒ³å­¦ä¹ ç¤¾</p>
</div>

<div class="auth-modal" id="authModal">
  <div class="auth-box">
    <span class="modal-close" onclick="closeAuth()">Ã—</span>
    <div class="auth-tabs">
      <div class="auth-tab active" data-mode="login">ç™»å½•</div>
      <div class="auth-tab" data-mode="reg">æ³¨å†Œ</div>
    </div>
    <div id="loginForm">
      <input class="auth-input" id="loginAcc" placeholder="è´¦å·">
      <input class="auth-input" id="loginPwd" type="password" placeholder="å¯†ç ">
      <button class="auth-btn" onclick="doLogin()">ç™»å½•</button>
    </div>
    <div id="regForm" style="display:none;">
      <input class="auth-input" id="regAcc" placeholder="è´¦å·">
      <input class="auth-input" id="regPwd" type="password" placeholder="å¯†ç ">
      <input class="auth-input" id="regNick" placeholder="æ˜µç§°">
      <button class="auth-btn" onclick="doReg()">æ³¨å†Œ</button>
    </div>
    <button class="cancel-login" onclick="closeAuth()">æ¸¸å®¢æµè§ˆ</button>
  </div>
</div>

<div class="pwd-modal" id="managePwdModal">
  <div class="pwd-box">
    <span class="modal-close" onclick="closePwdModal()">Ã—</span>
    <h3 style="color:#ffd700;text-align:center;">ç®¡ç†æƒé™éªŒè¯</h3>
    <input class="pwd-input" id="managePwd" type="password" placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç ">
    <button class="pwd-btn" onclick="checkManagePwd()">éªŒè¯è¿›å…¥</button>
  </div>
</div>

<div class="reject-modal" id="rejectModal">
  <div class="reject-box">
    <span class="modal-close" onclick="closeRejectModal()">Ã—</span>
    <h3 style="color:#ffd700;text-align:center;">å¡«å†™é©³å›ç†ç”±</h3>
    <textarea class="reject-reason" id="reasonInput" placeholder="é©³å›ç†ç”±ä¸èƒ½ä¸ºç©º"></textarea>
    <button class="reject-btn" onclick="confirmReject()">ç¡®è®¤é©³å›</button>
  </div>
</div>

<div class="main-app" id="mainApp">
  <div class="user-bar">
    <div class="user-info">
      <img src="https://picsum.photos/80/80" class="avatar">
      <span class="user-name" id="nickBar"></span>
    </div>
    <span class="logout" onclick="logout()">é€€å‡ºç™»å½•</span>
  </div>

  <div class="search-bar">
    <input class="search-input" id="searchInput" placeholder="æœç´¢ç”¨æˆ·ï¼ˆæ˜µç§°/è´¦å·ï¼‰" oninput="doSearch()">
  </div>

  <div class="navbar">
    <h1>æ–°æ€æƒ³å­¦ä¹ ç¤¾</h1>
    <div class="nav-links-first">
      <span class="nav-link active" onclick="go('home')">é¦–é¡µ</span>
      <span class="nav-link" onclick="go('article')">æœ€æ–°æ–‡ç« </span>
      <span class="nav-link member-only" onclick="go('publish')">å‘å¸ƒæ–‡ç« </span>
      <span class="nav-link member-only" onclick="go('chat')">ç§èŠ</span>
    </div>
    <div class="nav-links-second">
      <span class="nav-link member-only" onclick="go('voice')">è¯­éŸ³ä¼šè®®</span>
      <span class="nav-link" onclick="go('userlist')">ç”¨æˆ·åˆ—è¡¨</span>
      <span class="nav-link" onclick="openManagePwd()">ç®¡ç†ä¸­å¿ƒ</span>
    </div>
  </div>

  <div class="container">
    <div id="home" class="card"><h3>å¹³å°ä»‹ç»</h3><p>æ”¯æŒæ–‡ç« å®¡æ ¸ã€ç§èŠã€è¯­éŸ³ã€ç”¨æˆ·æœç´¢ã€å°å·ç®¡ç†ã€‚</p></div>
    <div id="article" class="card" style="display:none;"><h3>æœ€æ–°æ–‡ç« ï¼ˆå·²é€šè¿‡ï¼‰</h3><div id="articleList"></div></div>
    <div id="publish" class="card" style="display:none;"><h3>å‘å¸ƒæ–‡ç« ï¼ˆéœ€å®¡æ ¸ï¼‰</h3><input class="auth-input" id="artTitle" placeholder="æ ‡é¢˜"><textarea class="auth-input" rows="7" id="artContent" placeholder="å†…å®¹"></textarea><button class="auth-btn" onclick="publishArt()">æäº¤å‘å¸ƒ</button></div>
    <div id="chat" class="card" style="display:none;"><h3>ç§èŠ</h3><div class="chat-layout"><div class="chat-user-list" id="chatUserList"></div><div class="chat-box"><div class="msg-area" id="msgArea"></div><div class="msg-input-area"><input class="msg-input" id="msgInput" onkeydown="event.key==='Enter'&&sendMsg()"><button class="send-btn" onclick="sendMsg()">å‘é€</button></div></div></div></div>
    <div id="voice" class="card" style="display:none;"><h3>è¯­éŸ³ä¼šè®®</h3><div class="meeting-header"><div>æˆ¿é—´ï¼š<span id="roomName">æœªåŠ å…¥</span></div><div class="meeting-controls"><button class="meeting-btn primary" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button><button class="meeting-btn secondary" id="micBtn" onclick="toggleMic()">ğŸ¤å¼€å¯éº¦å…‹é£</button><button class="meeting-btn secondary" onclick="leaveRoom()">ç¦»å¼€</button></div></div><div class="participant-list" id="partList"></div></div>
    <div id="userlist" class="card" style="display:none;"><h3>ç”¨æˆ·åˆ—è¡¨</h3><div id="searchResult"></div></div>
    <div id="manage" class="card" style="display:none;"><h3>ç®¡ç†ä¸­å¿ƒ</h3><div style="margin-bottom:20px;"><h4 style="color:#ffd700;text-align:center;">æ–‡ç« å®¡æ ¸</h4><div id="auditList"></div></div><div><h4 style="color:#ffd700;text-align:center;">ç”¨æˆ·å°å·ç®¡ç†</h4><div id="banUserList"></div></div></div>
  </div>
</div>

<script>
const STORAGE = {users:"ntlc_users", cur:"ntlc_cur", arts:"ntlc_arts", chats:"ntlc_chats", meets:"ntlc_meets"};
const MANAGE_PASSWORD = "159357258";

let users = JSON.parse(localStorage.getItem(STORAGE.users)||"[]");
let cur = JSON.parse(localStorage.getItem(STORAGE.cur)||null);
let arts = JSON.parse(localStorage.getItem(STORAGE.arts)||"[]");
let chats = JSON.parse(localStorage.getItem(STORAGE.chats)||"[]");
let meets = JSON.parse(localStorage.getItem(STORAGE.meets)||"[]");

let currentRoom = null;
let mic = false;
let stream = null;
let chatTo = null;
let currentRejectId = null;

setTimeout(()=>{
  document.body.style.overflow="auto";
  cur ? closeAuth() : (document.getElementById("authModal").style.display="flex");
}, 4500);

document.querySelectorAll(".auth-tab").forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll(".auth-tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const m = t.dataset.mode;
    document.getElementById("loginForm").style.display = m==="login"?"block":"none";
    document.getElementById("regForm").style.display = m==="reg"?"block":"none";
  }
});

function closeAuth(){
  document.getElementById("authModal").style.display="none";
  document.getElementById("mainApp").style.display="block";
  if(!cur){document.getElementById("mainApp").classList.remove("has-account");document.getElementById("nickBar").innerText="æ¸¸å®¢";return;}
  document.getElementById("mainApp").classList.add("has-account");
  document.getElementById("nickBar").innerText = cur.nick;
}

function doReg(){
  const acc = document.getElementById("regAcc").value.trim();
  const pwd = document.getElementById("regPwd").value.trim();
  const nick = document.getElementById("regNick").value.trim();
  if(!acc||!pwd||!nick) return alert("è¯·å®Œæ•´å¡«å†™");
  if(users.some(u=>u.account===acc)) return alert("è´¦å·å·²å­˜åœ¨");
  const u = {uid:"u"+Date.now(), account:acc, pwd:pwd, nick:nick, status:"normal"};
  users.push(u);
  localStorage.setItem(STORAGE.users, JSON.stringify(users));
  alert("æ³¨å†ŒæˆåŠŸ");
  document.querySelector(".auth-tab[data-mode='login']").click();
}

function doLogin(){
  const acc = document.getElementById("loginAcc").value.trim();
  const pwd = document.getElementById("loginPwd").value.trim();
  const u = users.find(x=>x.account===acc&&x.pwd===pwd);
  if(!u) return alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
  if(u.status==="ban") return alert("è¯¥è´¦å·å·²è¢«å°ç¦ï¼");
  cur = u;
  localStorage.setItem(STORAGE.cur, JSON.stringify(cur));
  closeAuth();
}

function go(page){
  document.querySelectorAll(".card").forEach(c=>c.style.display="none");
  document.getElementById(page).style.display="block";
  document.querySelectorAll(".nav-link").forEach(n=>n.classList.remove("active"));
  document.querySelector(`.nav-link[onclick*="${page}"]`)?.classList.add("active");
  switch(page){
    case "article": renderArticles(); break;
    case "chat": loadChatUsers(); break;
    case "voice": renderRoom(); break;
    case "manage": renderManageCenter(); break;
    case "userlist": renderAllUsers(); break;
  }
}

// æœç´¢å½»åº•ä¿®å¤ï¼Œè¿™é‡Œæ˜¯å…³é”®
function doSearch(){
  const kw = document.getElementById("searchInput").value.trim().toLowerCase();
  go("userlist");
  const el = document.getElementById("searchResult");
  if(!kw){
    renderAllUsers();
    return;
  }
  const res = users.filter(u=>
    u.nick.toLowerCase().includes(kw) || u.account.toLowerCase().includes(kw)
  );
  el.innerHTML = res.length ? res.map(u=>`
  <div style='padding:10px;border-bottom:1px solid #fff2;'>
    <div style='color:#ffd700;font-weight:bold;'>${u.nick}</div>
    <div style='font-size:12px;color:#ccc;'>è´¦å·ï¼š${u.account}ï½œ${u.status==="normal"?"æ­£å¸¸":"å·²å°ç¦"}</div>
    <button class='btn btn-sm btn-yellow' onclick='openChat("${u.uid}","${u.nick}")'>å‘èµ·ç§èŠ</button>
  </div>
  `).join("") : "<p style='text-align:center;color:#ccc;'>æ— åŒ¹é…ç”¨æˆ·</p>";
}

function renderAllUsers(){
  const list = users.filter(u=>!cur||u.uid!==cur.uid);
  const el = document.getElementById("searchResult");
  el.innerHTML = list.length ? list.map(u=>`
  <div style='padding:10px;border-bottom:1px solid #fff2;'>
    <div style='color:#ffd700;font-weight:bold;'>${u.nick}</div>
    <div style='font-size:12px;color:#ccc;'>è´¦å·ï¼š${u.account}ï½œ${u.status==="normal"?"æ­£å¸¸":"å·²å°ç¦"}</div>
    <button class='btn btn-sm btn-yellow' onclick='openChat("${u.uid}","${u.nick}")'>å‘èµ·ç§èŠ</button>
  </div>
  `).join("") : "<p style='text-align:center;color:#ccc;'>æš‚æ— å…¶ä»–ç”¨æˆ·</p>";
}

function openManagePwd(){
  document.getElementById("managePwd").value="";
  document.getElementById("managePwdModal").style.display="flex";
}
function closePwdModal(){document.getElementById("managePwdModal").style.display="none";}
function checkManagePwd(){
  if(document.getElementById("managePwd").value.trim()===MANAGE_PASSWORD){closePwdModal();go("manage");}
  else alert("å¯†ç é”™è¯¯ï¼");
}

function openRejectModal(aid){currentRejectId=aid;document.getElementById("rejectModal").style.display="flex";}
function closeRejectModal(){currentRejectId=null;document.getElementById("rejectModal").style.display="none";}
function confirmReject(){
  const r=document.getElementById("reasonInput").value.trim();
  if(!r)return alert("è¯·å¡«å†™ç†ç”±");
  const a=arts.find(x=>x.id===currentRejectId);
  if(a){a.status="reject";a.rejectReason=r;localStorage.setItem(STORAGE.arts,JSON.stringify(arts));alert("å·²é©³å›");closeRejectModal();renderManageCenter();}
}
function passArticle(aid){
  const a=arts.find(x=>x.id===aid);
  if(a){a.status="pass";localStorage.setItem(STORAGE.arts,JSON.stringify(arts));alert("å·²é€šè¿‡");renderManageCenter();}
}

function toggleBan(uid){
  const u=users.find(x=>x.uid===uid);
  if(!u)return;
  u.status=u.status==="normal"?"ban":"normal";
  localStorage.setItem(STORAGE.users,JSON.stringify(users));
  alert(`å·²${u.status==="ban"?"å°ç¦":"è§£å°"}`);
  renderManageCenter();
}

function renderManageCenter(){
  const pending=arts.filter(a=>a.status==="pending");
  document.getElementById("auditList").innerHTML=pending.length?pending.map(a=>`
  <div style='padding:12px;border-bottom:1px solid #fff3;'>
    <div style='color:#ffd700;font-weight:bold;'>${a.title}</div>
    <div style='font-size:12px;color:#ccc;'>${a.nick} ${a.time}</div>
    <div style='margin:8px 0;'>${a.content.substring(0,150)}...</div>
    <button class='btn btn-sm btn-green' onclick='passArticle("${a.id}")'>é€šè¿‡</button>
    <button class='btn btn-sm btn-red' onclick='openRejectModal("${a.id}")'>é©³å›</button>
  </div>
  `).join(""):"<p style='text-align:center;color:#ccc;'>æš‚æ— å¾…å®¡æ ¸</p>";

  document.getElementById("banUserList").innerHTML=users.map(u=>`
  <div style='padding:10px;border-bottom:1px solid #fff2;display:flex;justify-content:space-between;'>
    <div><span style='color:#ffd700;'>${u.nick}</span> <span style='font-size:12px;color:#ccc;'>${u.account}</span> <span style='background:${u.status==="normal"?"#28a050":"red"};color:#fff;padding:2px 6px;border-radius:4px;'>${u.status}</span></div>
    <button class='btn btn-sm ${u.status==="normal"?"btn-red":"btn-green"}' onclick='toggleBan("${u.uid}")'>${u.status==="normal"?"å°ç¦":"è§£å°"}</button>
  </div>
  `).join("");
}

function publishArt(){
  if(!cur)return alert("è¯·ç™»å½•");
  const t=document.getElementById("artTitle").value.trim();
  const c=document.getElementById("artContent").value.trim();
  if(!t||!c)return alert("æ ‡é¢˜å†…å®¹ä¸èƒ½ä¸ºç©º");
  arts.unshift({id:"a"+Date.now(),title:t,content:c,uid:cur.uid,nick:cur.nick,status:"pending",rejectReason:"",time:new Date().toLocaleString()});
  localStorage.setItem(STORAGE.arts,JSON.stringify(arts));
  alert("æäº¤æˆåŠŸï¼Œå¾…å®¡æ ¸");
  document.getElementById("artTitle").value="";
  document.getElementById("artContent").value="";
  go("article");
}

function renderArticles(){
  const list=arts.filter(x=>x.status==="pass");
  document.getElementById("articleList").innerHTML=list.length?list.map(a=>`
  <div class="article-item">
    <div class="article-title">${a.title}</div>
    <div class="article-meta">${a.nick}ï½œ${a.time}</div>
    <div class="article-content">${a.content}</div>
  </div>
  `).join(""):"<p style='text-align:center;color:#ccc;'>æš‚æ— å·²é€šè¿‡æ–‡ç« </p>";
}

function loadChatUsers(){
  if(!cur)return;
  const list=users.filter(u=>u.uid!==cur.uid&&u.status==="normal");
  const el=document.getElementById("chatUserList");
  el.innerHTML=list.length?list.map(u=>{
    const unread=chats.filter(m=>m.from===u.uid&&m.to===cur.uid&&!m.read).length;
    return `<div class="chat-user-item" onclick="openChat('${u.uid}','${u.nick}')"><div class="chat-user-name">${u.nick} ${unread>0?`<span class="unread-tag">${unread}</span>`:""}</div></div>`;
  }).join(""):"<p style='text-align:center;color:#ccc;'>æ— å¯ç”¨èŠå¤©ç”¨æˆ·</p>";
  document.getElementById("msgArea").innerHTML="<p style='text-align:center;color:#ccc;'>é€‰æ‹©ç”¨æˆ·èŠå¤©</p>";
}

function openChat(uid,nick){
  if(!cur)return;
  chatTo=uid;
  document.querySelectorAll(".chat-user-item").forEach(i=>i.classList.remove("active"));
  document.querySelector(`.chat-user-item[onclick*="${uid}"]`)?.classList.add("active");
  chats.forEach(m=>{if(m.from===uid&&m.to===cur.uid)m.read=true;});
  localStorage.setItem(STORAGE.chats,JSON.stringify(chats));
  renderMsg();
  loadChatUsers();
}

function renderMsg(){
  if(!chatTo||!cur)return;
  const list=chats.filter(m=>(m.from===cur.uid&&m.to===chatTo)||(m.from===chatTo&&m.to===cur.uid));
  const el=document.getElementById("msgArea");
  el.innerHTML=list.map(m=>`
  <div class="msg-item ${m.from===cur.uid?'msg-me':'msg-other'}">
    <div>${m.text}</div>
    <div class="msg-status">${m.time}ï½œ${m.read?'å·²è¯»':'æœªè¯»'}</div>
  </div>
  `).join("");
  el.scrollTop=el.scrollHeight;
}

function sendMsg(){
  if(!cur||!chatTo)return;
  const t=document.getElementById("msgInput").value.trim();
  if(!t)return;
  chats.push({from:cur.uid,to:chatTo,text:t,time:new Date().toLocaleString(),read:false});
  localStorage.setItem(STORAGE.chats,JSON.stringify(chats));
  document.getElementById("msgInput").value="";
  renderMsg();
  loadChatUsers();
}

function createRoom(){
  if(!cur)return;
  const n=prompt("æˆ¿é—´åï¼š");
  if(!n)return;
  const r={id:"m"+Date.now(),name:n,creator:cur.uid,users:[cur.uid]};
  meets.push(r);currentRoom=r;
  localStorage.setItem(STORAGE.meets,JSON.stringify(meets));
  renderRoom();
}

function renderRoom(){
  if(!currentRoom){document.getElementById("roomName").innerText="æœªåŠ å…¥";document.getElementById("partList").innerHTML="<p>æ— å‚ä¼šè€…</p>";return;}
  document.getElementById("roomName").innerText=currentRoom.name;
  const ps=users.filter(u=>currentRoom.users.includes(u.uid)&&u.status==="normal");
  document.getElementById("partList").innerHTML=ps.map(u=>`
  <div class="participant">
    <div class="part-avatar">${u.nick[0]||"?"}</div>
    <div>${u.nick}</div>
  </div>
  `).join("");
}

async function toggleMic(){
  if(!mic){try{stream=await navigator.mediaDevices.getUserMedia({audio:true});mic=true;document.getElementById("micBtn").innerText="ğŸ”‡å…³é—­éº¦å…‹é£";}catch(e){alert("éº¦å…‹é£æƒé™è¢«æ‹’ç»");}}
  else{stream?.getTracks().forEach(t=>t.stop());stream=null;mic=false;document.getElementById("micBtn").innerText="ğŸ¤å¼€å¯éº¦å…‹é£";}
}

function leaveRoom(){
  if(!currentRoom)return;
  currentRoom.users=currentRoom.users.filter(u=>u!==cur?.uid);
  if(currentRoom.users.length===0)meets=meets.filter(m=>m.id!==currentRoom.id);
  localStorage.setItem(STORAGE.meets,JSON.stringify(meets));
  currentRoom=null;stream?.getTracks().forEach(t=>t.stop());stream=null;mic=false;
  document.getElementById("micBtn").innerText="ğŸ¤å¼€å¯éº¦å…‹é£";
  renderRoom();
}

function logout(){
  cur=null;localStorage.removeItem(STORAGE.cur);
  stream?.getTracks().forEach(t=>t.stop());stream=null;mic=false;currentRoom=null;
  document.getElementById("authModal").style.display="flex";
  document.getElementById("mainApp").style.display="none";
  document.getElementById("mainApp").classList.remove("has-account");
}
</script>
</body>
</html>
