<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°æ€æƒ³å­¦ä¹ ç¤¾ - çº¿ä¸ŠæŠ•ç¨¿å¹³å°</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      background-color: #b81c1c;
      min-height: 100vh;
      color: #fff;
      font-family: sans-serif;
      line-height: 1.6;
      overflow: hidden;
    }

    /* å¼€åœºNTLCé€å­—æ¯åŠ¨ç”»ï¼ˆè°·æ­Œé£æ ¼ï¼‰ */
    .splash-screen {
      position: fixed;
      top: 0; left: 0;
      width:100%; height:100%;
      background:#fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      animation: splashFade 2.5s ease forwards;
      animation-delay: 3s;
    }
    .ntlc-logo {
      display: flex;
      gap: 12px;
      font-size: 80px;
      font-weight: 900;
      margin-bottom: 40px;
    }
    .ntlc-letter {
      opacity: 0;
      transform: scale(0.5);
      animation: letterPop 0.6s ease forwards;
    }
    .ntlc-letter:nth-child(1) { color: #4285F4; animation-delay: 0.2s; }
    .ntlc-letter:nth-child(2) { color: #EA4335; animation-delay: 0.4s; }
    .ntlc-letter:nth-child(3) { color: #FBBC05; animation-delay: 0.6s; }
    .ntlc-letter:nth-child(4) { color: #34A853; animation-delay: 0.8s; }

    @keyframes letterPop {
      0% { opacity:0; transform:scale(0.5); }
      70% { opacity:1; transform:scale(1.1); }
      100% { opacity:1; transform:scale(1); }
    }
    @keyframes splashFade {
      0% { opacity:1; }
      100% { opacity:0; visibility:hidden; }
    }

    /* ç™»å½•å¼¹çª— */
    .auth-modal {
      position: fixed;
      top: 0; left: 0;
      width:100%; height:100%;
      background:rgba(80,0,0,0.8);
      z-index:99999;
      display:none;
      align-items:center;justify-content:center;
      animation:fadeIn 0.3s forwards;
    }
    @keyframes fadeIn {0%{opacity:0;}100%{opacity:1;}}
    .modal-close {
      position:absolute;top:15px;right:15px;
      font-size:24px;color:#ffd700;
      width:30px;height:30px;border-radius:50%;
      background:rgba(255,255,255,0.1);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:0.2s;
    }
    .modal-close:hover {background:#ffd700;color:#5a0000;transform:rotate(90deg);}
    .auth-box {
      background:#801010;padding:30px;border-radius:12px;
      width:90%;max-width:420px;position:relative;
      animation:popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
      transform:scale(0);
    }
    @keyframes popIn {0%{transform:scale(0);}70%{transform:scale(1.05);}100%{transform:scale(1);}}
    .auth-tabs {display:flex;gap:10px;margin-bottom:25px;}
    .auth-tab {flex:1;padding:12px;text-align:center;background:rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;color:#ccc;}
    .auth-tab.active {background:#ffd700;color:#5a0000;font-weight:bold;}
    .auth-input {
      width:100%;padding:14px;margin-bottom:15px;border-radius:8px;
      background:rgba(255,255,255,0.1);color:#fff;
      border:1px solid rgba(255,215,0,0.5);outline:none;font-size:16px;
    }
    .auth-input::placeholder {color:#ffd70080;}
    .auth-btn {
      width:100%;padding:14px;border-radius:8px;
      background:#ffd700;color:#5a0000;font-weight:bold;border:none;
      cursor:pointer!important;font-size:16px;transition:0.1s;
    }
    .auth-btn:hover {transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.2);}
    .cancel-login {
      width:100%;margin-top:10px;padding:12px;border-radius:8px;
      background:rgba(255,255,255,0.1);color:#ffd700;
      border:1px solid #ffd700;cursor:pointer;font-size:14px;transition:0.2s;
    }
    .cancel-login:hover {background:rgba(255,215,0,0.2);color:#fff;}

    /* ä¸»ä½“ - é€‚é…ç§»åŠ¨ç«¯æˆªå›¾æ ·å¼ */
    .main-app {display:none;padding:0;overflow:auto;height:100vh;}
    .user-bar {
      background:#801010;padding:10px 15px;
      display:flex;justify-content:space-between;align-items:center;
      font-size:14px;
    }
    .user-avatar {width:32px;height:32px;border-radius:50%;border:2px solid #ffd700;}
    .user-name {color:#ffd700;font-weight:bold;margin-left:10px;}
    .user-info {display:flex;align-items:center;}
    .user-link {color:#fff;cursor:pointer;}
    .user-link:hover {color:#ffd700;}

    /* å¯¼èˆªæ  - å®Œå…¨åŒ¹é…æˆªå›¾æ ·å¼ */
    .navbar {
      background:#801010;padding:15px 10px;
      text-align:center;
      position:sticky;top:0;z-index:100;
      border-bottom:1px solid rgba(255,215,0,0.3);
    }
    .navbar h1 {color:#fff;font-size:28px;margin-bottom:15px;}
    .nav-links {
      display:flex;justify-content:center;
      gap:10px;margin-bottom:10px;
      flex-wrap:wrap;
    }
    .nav-link {
      color:#fff;text-decoration:none;
      padding:8px 16px;border-radius:8px;
      cursor:pointer;transition:0.2s;
      font-size:16px;
    }
    .nav-link.active {
      background:#ffd700;color:#5a0000;
      font-weight:bold;
    }
    .nav-link:hover {
      background:rgba(255,215,0,0.1);color:#ffd700;
    }

    .container {
      max-width:800px;margin:0 auto;
      padding:15px 10px;
    }
    .card {
      background:#801010;padding:20px;border-radius:12px;
      margin-bottom:15px;
      animation:cardFadeIn 0.5s forwards;
      opacity:0;transform:translateY(20px);
    }
    @keyframes cardFadeIn {to{opacity:1;transform:translateY(0);}}
    .card h3 {
      color:#ffd700;text-align:center;
      margin-bottom:15px;font-size:22px;
    }

    /* æƒé™æ§åˆ¶ */
    .member-only {display:none;}
    .has-account .member-only {display:inline-block;}
    .admin-only {display:none;}
    .is-admin .admin-only {display:inline-block;}

    /* ç§ä¿¡æ ·å¼ */
    .chat-layout {display:grid;grid-template-columns:220px 1fr;gap:15px;margin-top:10px;}
    .chat-user-list {height:450px;overflow-y:auto;background:rgba(255,255,255,0.07);border-radius:8px;padding:8px;}
    .chat-user-item {padding:10px;border-radius:6px;margin-bottom:6px;cursor:pointer;}
    .chat-user-item:hover,.chat-user-item.active {background:rgba(255,215,0,0.15);}
    .chat-user-name {color:#ffd700;font-weight:bold;font-size:14px;}
    .chat-box {height:450px;display:flex;flex-direction:column;gap:10px;}
    .chat-message-area {flex:1;background:rgba(0,0,0,0.15);border-radius:8px;padding:12px;overflow-y:auto;}
    .chat-input-area {display:flex;gap:8px;}
    .chat-input {flex:1;padding:12px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,215,0,0.3);}
    .chat-send-btn {padding:0 16px;background:#ffd700;color:#5a0000;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
    .msg-item {max-width:75%;margin-bottom:10px;padding:8px 12px;border-radius:12px;line-height:1.4;}
    .msg-me {margin-left:auto;background:#ffd700;color:#5a0000;border-bottom-right-radius:4px;}
    .msg-other {margin-right:auto;background:rgba(255,255,255,0.1);color:#fff;border-bottom-left-radius:4px;}
    .msg-time {font-size:10px;color:#ccc;text-align:right;margin-top:2px;}

    /* è¯­éŸ³ä¼šè®®ï¼ˆå®Œæ•´ä¿ç•™ï¼Œè…¾è®¯ä¼šè®®é£æ ¼ï¼‰ */
    .meeting-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
    .meeting-title {color:#ffd700;font-weight:bold;}
    .meeting-controls {display:flex;gap:8px;}
    .meeting-btn {padding:8px 14px;border-radius:6px;border:none;cursor:pointer;}
    .meeting-btn.primary {background:#ffd700;color:#5a0000;}
    .meeting-btn.secondary {background:rgba(255,255,255,0.1);color:#fff;}
    .participant-list {display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;}
    .participant {background:rgba(255,255,255,0.07);padding:12px;border-radius:8px;text-align:center;}
    .participant-avatar {width:40px;height:40px;border-radius:50%;background:#ffd700;color:#5a0000;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-weight:bold;}

    /* æ–‡ç« æ ·å¼ - æœ€æ–°æ–‡ç« ä¸“å± */
    .article-item {padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:10px;}
    .article-title {color:#ffd700;font-weight:bold;font-size:18px;}
    .article-meta {font-size:12px;color:#ccc;margin:4px 0;}
    .article-content {font-size:15px;color:#eee;line-height:1.7;}

    .btn {padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:bold;margin-right:4px;}
    .btn-sm {padding:4px 8px;font-size:12px;}
    .btn-green {background:#28a050;color:#fff;}
    .btn-red {background:#c81010;color:#fff;}
    .btn-primary {background:#ffd700;color:#5a0000;}
  </style>
</head>
<body>

<!-- å¼€åœºåŠ¨ç”» -->
<div class="splash-screen">
  <div class="ntlc-logo">
    <span class="ntlc-letter">N</span>
    <span class="ntlc-letter">T</span>
    <span class="ntlc-letter">L</span>
    <span class="ntlc-letter">C</span>
  </div>
  <p style="color:#666;font-size:20px;">æ–°æ€æƒ³å­¦ä¹ ç¤¾</p>
</div>

<!-- ç™»å½•å¼¹çª— -->
<div class="auth-modal" id="authModal">
  <div class="auth-box">
    <span class="modal-close" id="modalClose">Ã—</span>
    <div class="auth-tabs">
      <div class="auth-tab active" data-mode="login">ç™»å½•</div>
      <div class="auth-tab" data-mode="register">æ³¨å†Œ</div>
    </div>
    <div id="loginForm">
      <input class="auth-input" id="loginAccount" placeholder="è´¦å·">
      <input class="auth-input" id="loginPwd" type="password" placeholder="å¯†ç ">
      <button class="auth-btn" onclick="doLogin()">ç™»å½•</button>
    </div>
    <div id="registerForm" style="display:none;">
      <input class="auth-input" id="regAccount" placeholder="è®¾ç½®è´¦å·">
      <input class="auth-input" id="regPwd" type="password" placeholder="è®¾ç½®å¯†ç ">
      <input class="auth-input" id="regNickname" placeholder="æ˜µç§°">
      <button class="auth-btn" onclick="doRegister()">æ³¨å†Œè´¦å·</button>
    </div>
    <button class="cancel-login" onclick="closeAuthModal()">å–æ¶ˆç™»å½•ï¼Œä»…æµè§ˆ</button>
  </div>
</div>

<!-- ä¸»ç•Œé¢ - åŒ¹é…æˆªå›¾å¸ƒå±€ -->
<div class="main-app" id="mainApp">
  <!-- ç”¨æˆ·æ  - æˆªå›¾å³ä¸Šè§’é€€å‡ºæ ·å¼ -->
  <div class="user-bar">
    <div class="user-info">
      <img src="https://picsum.photos/80/80" class="user-avatar">
      <span class="user-name" id="barName"></span>
    </div>
    <span class="user-link" onclick="logout()">é€€å‡ºç™»å½•</span>
  </div>

  <!-- å¯¼èˆªæ  - å®Œå…¨åŒ¹é…æˆªå›¾ï¼šé¦–é¡µã€æœ€æ–°æ–‡ç« ã€ç”¨æˆ·åˆ—è¡¨ + ç™»å½•åæ˜¾ç¤ºçš„åŠŸèƒ½ -->
  <nav class="navbar">
    <h1>æ–°æ€æƒ³å­¦ä¹ ç¤¾</h1>
    <div class="nav-links">
      <span class="nav-link active" onclick="switchPage('home')">é¦–é¡µ</span>
      <span class="nav-link" onclick="switchPage('latest')">æœ€æ–°æ–‡ç« </span>
      <span class="nav-link member-only" onclick="switchPage('submit')">æŠ•ç¨¿</span>
      <span class="nav-link member-only" onclick="switchPage('chat')">ç§ä¿¡</span>
      <span class="nav-link member-only" onclick="switchPage('meeting')">è¯­éŸ³ä¼šè®®</span>
      <span class="nav-link admin-only" onclick="switchPage('admin')">ç®¡ç†å‘˜è®¾ç½®</span>
    </div>
    <div class="nav-links">
      <span class="nav-link" onclick="switchPage('user')">ç”¨æˆ·åˆ—è¡¨</span>
    </div>
  </nav>

  <div class="container">
    <!-- é¦–é¡µ -->
    <div id="home" class="card">
      <h3>å¹³å°ä»‹ç»</h3>
      <p style="font-size:16px;line-height:1.8;text-align:justify;">
        æœ¬ç¤¾ä¸“æ³¨æ€æƒ³ç†è®ºå­¦ä¹ ã€å¾æ–‡æŠ•ç¨¿ã€çº¿ä¸Šäº¤æµã€è¯­éŸ³ä¼šè®®ã€ç§ä¿¡æ²Ÿé€šä¸€ä½“åŒ–å¹³å°ã€‚
      </p>
    </div>

    <!-- æœ€æ–°æ–‡ç« ï¼ˆæ ¸å¿ƒæ¢å¤ï¼Œç§»é™¤å¾®è¯»ï¼Œçº¯æ–‡ç« å±•ç¤ºï¼‰ -->
    <div id="latest" class="card" style="display:none;">
      <h3>æœ€æ–°æ–‡ç« </h3>
      <div id="latestArticles"><p style="text-align:center;color:#ccc;">æš‚æ— æŠ•ç¨¿æ–‡ç« </p></div>
    </div>

    <!-- æŠ•ç¨¿ä¸­å¿ƒ -->
    <div id="submit" class="card" style="display:none;">
      <h3>æŠ•ç¨¿ä¸­å¿ƒ</h3>
      <input class="auth-input" id="artTitle" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" style="margin-bottom:10px;">
      <textarea class="auth-input" id="artContent" rows="8" placeholder="è¯·è¾“å…¥æ–‡ç« å†…å®¹"></textarea>
      <button class="auth-btn" onclick="submitArticle()" style="margin-top:10px;">æäº¤æŠ•ç¨¿</button>
    </div>

    <!-- ç§ä¿¡åŠŸèƒ½ -->
    <div id="chat" class="card" style="display:none;">
      <h3>ç§ä¿¡èŠå¤©</h3>
      <div class="chat-layout">
        <div class="chat-user-list" id="chatUserList"></div>
        <div class="chat-box">
          <div class="chat-message-area" id="msgArea"></div>
          <div class="chat-input-area">
            <input class="chat-input" id="msgInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeydown="if(event.key==='Enter')sendChatMsg()">
            <button class="chat-send-btn" onclick="sendChatMsg()">å‘é€</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è¯­éŸ³ä¼šè®®ï¼ˆå®Œæ•´æ¢å¤ï¼Œç™»å½•åå¯è§ï¼‰ -->
    <div id="meeting" class="card" style="display:none;">
      <h3>è¯­éŸ³ä¼šè®®</h3>
      <div class="meeting-header">
        <div class="meeting-title">å½“å‰ä¼šè®®ï¼š<span id="roomName">æœªåŠ å…¥</span></div>
        <div class="meeting-controls">
          <button class="meeting-btn primary" onclick="createRoom()">åˆ›å»ºä¼šè®®</button>
          <button class="meeting-btn secondary" id="micBtn" onclick="toggleMic()">ğŸ¤ å¼€å¯éº¦å…‹é£</button>
          <button class="meeting-btn secondary" onclick="leaveRoom()">ç¦»å¼€ä¼šè®®</button>
        </div>
      </div>
      <div class="participant-list" id="pList"></div>
    </div>

    <!-- ç®¡ç†å‘˜è®¾ç½® -->
    <div id="admin" class="card" style="display:none;">
      <h3>ç®¡ç†å‘˜è®¾ç½®</h3>
      <div style="margin-bottom:20px;">
        <h4 style="color:#ffd700;margin-bottom:10px;">ç”¨æˆ·ç®¡ç†</h4>
        <div id="adminUsers"></div>
      </div>
      <div>
        <h4 style="color:#ffd700;margin-bottom:10px;">æ–‡ç« å®¡æ ¸</h4>
        <div id="adminArts"></div>
      </div>
    </div>

    <!-- ç”¨æˆ·åˆ—è¡¨ -->
    <div id="user" class="card" style="display:none;">
      <h3>ç”¨æˆ·åˆ—è¡¨</h3>
      <div id="allUserList"></div>
    </div>
  </div>
</div>

<script>
// å…¨å±€å­˜å‚¨KEY
const LK = {
  users:"ntlc_users", current:"ntlc_cur", 
  articles:"ntlc_arts", meetings:"ntlc_meet", 
  chats:"ntlc_chats"
};

// å…¨å±€æ•°æ®
let users = JSON.parse(localStorage.getItem(LK.users)||"[]");
let curUser = JSON.parse(localStorage.getItem(LK.current)||"null");
let articles = JSON.parse(localStorage.getItem(LK.articles)||"[]");
let meetings = JSON.parse(localStorage.getItem(LK.meetings)||"[]");
let chats = JSON.parse(localStorage.getItem(LK.chats)||"[]");

// ä¼šè®®ç›¸å…³å…¨å±€å˜é‡
let currentRoom = null;
let micOn = false;
let localStream = null;
// ç§ä¿¡ç›¸å…³å…¨å±€å˜é‡
let chatToUid = null;

// å¼€åœºåŠ¨ç”»ç»“æŸåæ‰§è¡Œ
setTimeout(()=>{
  document.body.style.overflow="auto";
  if (curUser) {
    closeAuthModal();
  } else {
    document.getElementById("authModal").style.display="flex";
  }
}, 4500);

// ç™»å½•æ³¨å†Œæ ‡ç­¾åˆ‡æ¢
document.querySelectorAll(".auth-tab").forEach(tab=>{
  tab.onclick = function() {
    const mode = this.dataset.mode;
    document.querySelectorAll(".auth-tab").forEach(t=>t.classList.remove("active"));
    this.classList.add("active");
    document.getElementById("loginForm").style.display = mode === "login" ? "block" : "none";
    document.getElementById("registerForm").style.display = mode === "register" ? "block" : "none";
  }
});

// å…³é—­ç™»å½•å¼¹çª—
function closeAuthModal() {
  document.getElementById("authModal").style.display = "none";
  document.getElementById("mainApp").style.display = "block";
  
  if (!curUser) {
    document.getElementById("mainApp").classList.remove("has-account", "is-admin");
    document.getElementById("barName").innerText = "æ¸¸å®¢";
    return;
  }

  // ç™»å½•åæƒé™èµ‹å€¼
  document.getElementById("mainApp").classList.add("has-account");
  if (curUser.role === "admin") {
    document.getElementById("mainApp").classList.add("is-admin");
  }
  document.getElementById("barName").innerText = curUser.nick;
}
document.getElementById("modalClose").onclick = closeAuthModal;

// æ³¨å†ŒåŠŸèƒ½
function doRegister() {
  const account = document.getElementById("regAccount").value.trim();
  const pwd = document.getElementById("regPwd").value.trim();
  const nick = document.getElementById("regNickname").value.trim();

  if (!account || !pwd || !nick) return alert("è¯·å®Œæ•´å¡«å†™è´¦å·ã€å¯†ç å’Œæ˜µç§°ï¼");
  if (users.some(u=>u.account === account)) return alert("è¯¥è´¦å·å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥ç™»å½•ï¼");

  const newUser = {
    uid: "u" + Date.now(),
    account,
    pwd,
    nick,
    role: account === "admin" ? "admin" : "user"
  };

  users.push(newUser);
  localStorage.setItem(LK.users, JSON.stringify(users));
  alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•ï¼");
  document.querySelector(".auth-tab[data-mode='login']").click();
}

// ç™»å½•åŠŸèƒ½
function doLogin() {
  const account = document.getElementById("loginAccount").value.trim();
  const pwd = document.getElementById("loginPwd").value.trim();
  const user = users.find(u=>u.account === account && u.pwd === pwd);

  if (!user) return alert("è´¦å·æˆ–å¯†ç é”™è¯¯ï¼");
  curUser = user;
  localStorage.setItem(LK.current, JSON.stringify(curUser));
  closeAuthModal();
}

// é¡µé¢åˆ‡æ¢æ ¸å¿ƒå‡½æ•°
function switchPage(pageId) {
  // éšè—æ‰€æœ‰å¡ç‰‡
  document.querySelectorAll(".card").forEach(card=>{
    card.style.display = "none";
  });
  // æ˜¾ç¤ºç›®æ ‡é¡µé¢
  document.getElementById(pageId).style.display = "block";
  // åˆ‡æ¢å¯¼èˆªæ¿€æ´»æ€
  document.querySelectorAll(".nav-link").forEach(link=>{
    link.classList.remove("active");
    if (link.onclick.toString().includes(pageId)) {
      link.classList.add("active");
    }
  });

  // é¡µé¢æ•°æ®åŠ è½½
  switch(pageId) {
    case "latest": renderLatestArticles(); break;
    case "chat": loadChatList(); break;
    case "meeting": renderMeetingRoom(); break;
    case "admin": renderAdminPanel(); break;
    case "user": renderUserList(); break;
  }
}

// æŠ•ç¨¿åŠŸèƒ½
function submitArticle() {
  const title = document.getElementById("artTitle").value.trim();
  const content = document.getElementById("artContent").value.trim();

  if (!title || !content) return alert("è¯·å¡«å†™æ ‡é¢˜å’Œæ–‡ç« å†…å®¹ï¼");
  const newArticle = {
    id: "a" + Date.now(),
    title,
    content,
    authorUid: curUser.uid,
    authorNick: curUser.nick,
    status: "pending", // pending-å¾…å®¡æ ¸ pass-å·²é€šè¿‡ reject-å·²é©³å›
    time: new Date().toLocaleString()
  };

  articles.unshift(newArticle);
  localStorage.setItem(LK.articles, JSON.stringify(articles));
  alert("æŠ•ç¨¿æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ï¼");
  // æ¸…ç©ºè¾“å…¥æ¡†
  document.getElementById("artTitle").value = "";
  document.getElementById("artContent").value = "";
  // è·³è½¬åˆ°æœ€æ–°æ–‡ç« é¡µ
  switchPage("latest");
}

// æ¸²æŸ“æœ€æ–°æ–‡ç« 
function renderLatestArticles() {
  const el = document.getElementById("latestArticles");
  // åªæ˜¾ç¤ºå·²é€šè¿‡çš„æ–‡ç« 
  const passArticles = articles.filter(a=>a.status === "pass");
  
  if (passArticles.length === 0) {
    el.innerHTML = "<p style='text-align:center;color:#ccc;'>æš‚æ— å·²å®¡æ ¸é€šè¿‡çš„æ–‡ç« </p>";
    return;
  }

  el.innerHTML = passArticles.map(article=>`
    <div class="article-item">
      <div class="article-title">${article.title}</div>
      <div class="article-meta">ä½œè€…ï¼š${article.authorNick} | å‘å¸ƒæ—¶é—´ï¼š${article.time}</div>
      <div class="article-content">${article.content}</div>
    </div>
  `).join("");
}

// ====================== ç§ä¿¡åŠŸèƒ½ ======================
function loadChatList() {
  const otherUsers = users.filter(u=>u.uid !== curUser.uid);
  const el = document.getElementById("chatUserList");

  if (otherUsers.length === 0) {
    el.innerHTML = "<p style='padding:10px;text-align:center;color:#ccc;'>æš‚æ— å…¶ä»–ç”¨æˆ·</p>";
    document.getElementById("msgArea").innerHTML = "<p style='text-align:center;color:#ccc;'>æš‚æ— èŠå¤©å¯¹è±¡</p>";
    return;
  }

  el.innerHTML = otherUsers.map(u=>`
    <div class="chat-user-item" onclick="openChat('${u.uid}', '${u.nick}')">
      <div class="chat-user-name">${u.nick}</div>
    </div>
  `).join("");
  document.getElementById("msgArea").innerHTML = "<p style='text-align:center;color:#ccc;'>é€‰æ‹©å·¦ä¾§ç”¨æˆ·å¼€å§‹èŠå¤©</p>";
}

function openChat(uid, nick) {
  chatToUid = uid;
  // æ¿€æ´»é€‰ä¸­çš„èŠå¤©å¯¹è±¡
  document.querySelectorAll(".chat-user-item").forEach(item=>item.classList.remove("active"));
  document.querySelector(`.chat-user-item[onclick*="${uid}"]`).classList.add("active");
  // æ¸²æŸ“èŠå¤©è®°å½•
  renderChatMsg();
}

function renderChatMsg() {
  if (!chatToUid) return;
  const myUid = curUser.uid;
  // ç­›é€‰åŒæ–¹çš„èŠå¤©è®°å½•
  const chatRecords = chats.filter(m=>
    (m.from === myUid && m.to === chatToUid) || (m.from === chatToUid && m.to === myUid)
  );

  const el = document.getElementById("msgArea");
  el.innerHTML = chatRecords.map(msg=>`
    <div class="msg-item ${msg.from === myUid ? 'msg-me' : 'msg-other'}">
      <div>${msg.text}</div>
      <div class="msg-time">${msg.time}</div>
    </div>
  `).join("");
  // æ»šåŠ¨åˆ°åº•éƒ¨
  el.scrollTop = el.scrollHeight;
}

function sendChatMsg() {
  const text = document.getElementById("msgInput").value.trim();
  if (!text || !chatToUid) return;

  const newMsg = {
    from: curUser.uid,
    to: chatToUid,
    text,
    time: new Date().toLocaleString()
  };

  chats.push(newMsg);
  localStorage.setItem(LK.chats, JSON.stringify(chats));
  // æ¸…ç©ºè¾“å…¥æ¡†
  document.getElementById("msgInput").value = "";
  // é‡æ–°æ¸²æŸ“
  renderChatMsg();
}

// ====================== è¯­éŸ³ä¼šè®®ï¼ˆå®Œæ•´æ¢å¤ï¼Œæ— é˜‰å‰²ï¼‰ ======================
function createRoom() {
  const roomName = prompt("è¯·è¾“å…¥ä¼šè®®åç§°ï¼š");
  if (!roomName) return;

  const newRoom = {
    id: "m" + Date.now(),
    name: roomName,
    creatorUid: curUser.uid,
    participantUids: [curUser.uid],
    createTime: new Date().toLocaleString()
  };

  meetings.push(newRoom);
  currentRoom = newRoom;
  localStorage.setItem(LK.meetings, JSON.stringify(meetings));
  renderMeetingRoom();
}

function renderMeetingRoom() {
  const roomNameEl = document.getElementById("roomName");
  const participantEl = document.getElementById("pList");

  if (!currentRoom) {
    roomNameEl.innerText = "æœªåŠ å…¥ä¼šè®®";
    participantEl.innerHTML = "<p style='text-align:center;color:#ccc;'>æš‚æ— å‚ä¼šè€…</p>";
    return;
  }

  roomNameEl.innerText = currentRoom.name;
  // ç­›é€‰å‚ä¼šè€…ä¿¡æ¯
  const participants = users.filter(u=>currentRoom.participantUids.includes(u.uid));
  
  participantEl.innerHTML = participants.map(user=>`
    <div class="participant">
      <div class="participant-avatar">${user.nick.charAt(0)}</div>
      <div style="font-size:14px;margin-top:5px;">${user.nick}</div>
      <div style="font-size:12px;color:#ccc;margin-top:3px;">
        ${user.uid === currentRoom.creatorUid ? "ä¸»æŒäºº" : "å‚ä¼šè€…"}
      </div>
    </div>
  `).join("");
}

// éº¦å…‹é£å¼€å…³
async function toggleMic() {
  if (!micOn) {
    // å¼€å¯éº¦å…‹é£
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      micOn = true;
      document.getElementById("micBtn").innerText = "ğŸ”‡ å…³é—­éº¦å…‹é£";
      alert("éº¦å…‹é£å·²å¼€å¯ï¼");
    } catch (err) {
      alert("è¯·å…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£æƒé™ï¼");
      return;
    }
  } else {
    // å…³é—­éº¦å…‹é£
    localStream.getTracks().forEach(track=>track.stop());
    localStream = null;
    micOn = false;
    document.getElementById("micBtn").innerText = "ğŸ¤ å¼€å¯éº¦å…‹é£";
    alert("éº¦å…‹é£å·²å…³é—­ï¼");
  }
}

// ç¦»å¼€ä¼šè®®
function leaveRoom() {
  if (!currentRoom) return;

  // ç§»é™¤å½“å‰ç”¨æˆ·
  currentRoom.participantUids = currentRoom.participantUids.filter(uid=>uid !== curUser.uid);
  // è‹¥æ— äººåˆ™åˆ é™¤ä¼šè®®
  if (currentRoom.participantUids.length === 0) {
    meetings = meetings.filter(m=>m.id !== currentRoom.id);
  }

  localStorage.setItem(LK.meetings, JSON.stringify(meetings));
  currentRoom = null;
  // å…³é—­éº¦å…‹é£
  if (localStream) {
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
  }
  micOn = false;
  document.getElementById("micBtn").innerText = "ğŸ¤ å¼€å¯éº¦å…‹é£";
  // é‡æ–°æ¸²æŸ“
  renderMeetingRoom();
}

// ====================== ç®¡ç†å‘˜åŠŸèƒ½ ======================
function renderAdminPanel() {
  if (!curUser || curUser.role !== "admin") {
    alert("æ‚¨æ— ç®¡ç†å‘˜æƒé™ï¼");
    switchPage("home");
    return;
  }

  const userListEl = document.getElementById("adminUsers");
  const artListEl = document.getElementById("adminArts");

  // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
  userListEl.innerHTML = users.map(user=>`
    <div style='padding:8px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;'>
      <div>
        <span style="color:#ffd700;">${user.nick}</span>
        <span style="font-size:12px;color:#ccc;margin-left:10px;">(${user.account})</span>
        <span style="font-size:12px;background:#ffd700;color:#5a0000;padding:2px 6px;border-radius:4px;margin-left:10px;">${user.role}</span>
      </div>
      <button class='btn btn-sm btn-red' onclick='deleteUser("${user.uid}")'>åˆ é™¤</button>
    </div>
  `).join("");

  // æ¸²æŸ“å¾…å®¡æ ¸æ–‡ç« 
  const pendingArts = articles.filter(a=>a.status === "pending");
  artListEl.innerHTML = pendingArts.length === 0 
    ? "<p style='color:#ccc;'>æš‚æ— å¾…å®¡æ ¸æ–‡ç« </p>"
    : pendingArts.map(art=>`
      <div style='padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:10px;'>
        <div style="color:#ffd700;font-weight:bold;">${art.title}</div>
        <div style="font-size:12px;color:#ccc;margin:5px 0;">ä½œè€…ï¼š${art.authorNick} | æŠ•ç¨¿æ—¶é—´ï¼š${art.time}</div>
        <div style="font-size:14px;color:#eee;margin-bottom:10px;">${art.content.substring(0, 100)}${art.content.length>100?"...":""}</div>
        <div>
          <button class='btn btn-sm btn-green' onclick='auditArticle("${art.id}", "pass")'>å®¡æ ¸é€šè¿‡</button>
          <button class='btn btn-sm btn-red' onclick='auditArticle("${art.id}", "reject")'>å®¡æ ¸é©³å›</button>
        </div>
      </div>
    `).join("");
}

// åˆ é™¤ç”¨æˆ·
function deleteUser(uid) {
  if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")) return;
  users = users.filter(u=>u.uid !== uid);
  localStorage.setItem(LK.users, JSON.stringify(users));
  renderAdminPanel();
}

// å®¡æ ¸æ–‡ç« 
function auditArticle(artId, result) {
  const article = articles.find(a=>a.id === artId);
  if (!article) return;
  article.status = result;
  localStorage.setItem(LK.articles, JSON.stringify(articles));
  renderAdminPanel();
  alert(`æ–‡ç« å·²${result === "pass" ? "å®¡æ ¸é€šè¿‡" : "å®¡æ ¸é©³å›"}ï¼`);
}

// ====================== ç”¨æˆ·åˆ—è¡¨ ======================
function renderUserList() {
  const el = document.getElementById("allUserList");
  const otherUsers = users.filter(u=>u.uid !== curUser.uid);

  if (otherUsers.length === 0) {
    el.innerHTML = "<p style='text-align:center;color:#ccc;'>æš‚æ— å…¶ä»–ç”¨æˆ·</p>";
    return;
  }

  el.innerHTML = otherUsers.map(user=>`
    <div style='padding:10px;border-bottom:1px solid rgba(255,255,255,0.1);'>
      <div style='color:#ffd700;font-weight:bold;font-size:16px;'>${user.nick}</div>
      <div style='font-size:14px;color:#ccc;margin-top:5px;'>è´¦å·ï¼š${user.account}</div>
      <div style='font-size:14px;color:#ccc;margin-top:3px;'>èº«ä»½ï¼š${user.role === "admin" ? "ç®¡ç†å‘˜" : "æ™®é€šç”¨æˆ·"}</div>
    </div>
  `).join("");
}

// é€€å‡ºç™»å½•
function logout() {
  curUser = null;
  localStorage.removeItem(LK.current);
  // å…³é—­éº¦å…‹é£
  if (localStream) {
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
  }
  micOn = false;
  currentRoom = null;
  // é‡ç½®ç•Œé¢
  document.getElementById("authModal").style.display = "flex";
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("mainApp").classList.remove("has-account", "is-admin");
}
</script>
</body>
</html>
