<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–°æ€æƒ³å­¦ä¹ ç¤¾</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{background:#b81c1c;color:#fff;font-family:sans-serif;line-height:1.6;height:100%;}
.splash-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;animation:splashFade 2.5s ease forwards;animation-delay:3s;}
.ntlc-logo{display:flex;gap:12px;font-size:80px;font-weight:900;margin-bottom:40px;}
.ntlc-letter{opacity:0;transform:scale(0.5);animation:letterPop 0.6s ease forwards;}
.ntlc-letter:nth-child(1){color:#4285F4;animation-delay:0.2s;}
.ntlc-letter:nth-child(2){color:#EA4335;animation-delay:0.4s;}
.ntlc-letter:nth-child(3){color:#FBBC05;animation-delay:0.6s;}
.ntlc-letter:nth-child(4){color:#34A853;animation-delay:0.8s;}
@keyframes letterPop{0%{opacity:0;transform:scale(0.5);}70%{opacity:1;transform:scale(1.1);}100%{opacity:1;transform:scale(1);}}
@keyframes splashFade{0%{opacity:1;}100%{opacity:0;visibility:hidden;}}

.auth-modal,.pwd-modal,.reject-modal,.api-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(80,0,0,0.8);z-index:999;display:none;align-items:center;justify-content:center;}
.auth-box,.pwd-box,.reject-box,.api-box{background:#801010;padding:30px;border-radius:12px;width:90%;max-width:420px;}
.modal-close{position:absolute;top:15px;right:15px;font-size:24px;color:#ffd700;cursor:pointer;}
.auth-tabs{display:flex;gap:10px;margin-bottom:20px;}
.auth-tab{flex:1;padding:12px;text-align:center;background:rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;}
.auth-tab.active{background:#ffd700;color:#5a0000;font-weight:bold;}
.auth-input,.pwd-input,.reject-reason,.api-input{width:100%;padding:14px;margin-bottom:12px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,215,0,0.3);outline:none;}
.reject-reason{height:100px;resize:none;}
.auth-btn,.pwd-btn,.reject-btn,.api-btn{width:100%;padding:14px;border-radius:8px;background:#ffd700;color:#5a0000;font-weight:bold;border:none;cursor:pointer;}
.cancel-login{width:100%;margin-top:10px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.1);color:#ffd700;border:1px solid #ffd700;cursor:pointer;}

.main-app{display:none;}
.user-bar{background:#801010;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;}
.avatar{width:32px;height:32px;border-radius:50%;border:2px solid #ffd700;object-fit:cover;}
.user-name{color:#ffd700;font-weight:bold;margin-left:6px;}
.logout{color:#fff;cursor:pointer;}

.search-bar{background:#801010;padding:8px 15px;text-align:center;}
.search-input{width:90%;max-width:400px;padding:10px 14px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #ffd70066;outline:none;}

.navbar{background:#801010;padding:12px;text-align:center;border-bottom:1px solid #ffd70033;}
.navbar h1{color:#fff;font-size:28px;margin-bottom:15px;}
.nav-links-first,.nav-links-second{display:flex;justify-content:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
.nav-link{color:#fff;padding:8px 16px;border-radius:8px;cursor:pointer;}
.nav-link.active{background:#ffd700;color:#801010;font-weight:bold;}

.container{max-width:800px;margin:0 auto;padding:15px 10px;}
.card{background:#801010;padding:20px;border-radius:12px;margin-bottom:15px;}
.card h3{color:#ffd700;text-align:center;margin-bottom:15px;}

.member-only{display:none;}
.has-account .member-only{display:inline-block;}

.article-item{padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:10px;}
.article-title{color:#ffd700;font-weight:bold;}
.article-meta{font-size:12px;color:#ccc;margin:4px 0;}
.article-content{margin:8px 0;line-height:1.6;}

.like-box{display:flex;align-items:center;gap:10px;margin:10px 0;}
.like-btn,.ai-eval-btn{background:#ffd700;color:#801010;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:12px;}
.ai-result{margin-top:10px;padding:10px;background:rgba(255,215,0,0.1);border-radius:6px;border-left:3px solid #ffd700;}
.eval-loading{color:#ffd700;font-style:italic;}

.comment-item{background:rgba(255,255,255,0.05);padding:8px 10px;border-radius:6px;margin-bottom:6px;font-size:14px;}
.comment-user{color:#ffd700;font-weight:bold;font-size:12px;}
.comment-text{color:#eee;margin-top:2px;}
.comment-input-box{display:flex;gap:6px;margin-top:10px;}
.comment-input{flex:1;padding:8px;border-radius:6px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #ffd70055;}
.send-comment-btn{padding:0 12px;background:#ffd700;color:#801010;border:none;border-radius:6px;cursor:pointer;}

.btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:bold;margin-right:4px;}
.btn-sm{padding:4px 8px;font-size:12px;}
.btn-green{background:#28a050;color:#fff;}
.btn-red{background:#c81010;color:#fff;}
.btn-yellow{background:#ffc107;color:#222;}

.form-row{margin-bottom:12px;}
.form-row label{display:block;margin-bottom:4px;color:#ffd700;font-weight:bold;}

/* åŸç‰ˆä¼šè®®æ ·å¼å®Œå…¨ä¿ç•™ï¼Œä¸åŠ¨ */
.meeting-room{margin-bottom:15px;}
.meeting-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;}
.meeting-name{font-weight:bold;color:#ffd700;}
.meeting-controls{display:flex;gap:8px;}
.meeting-btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;background:#ffd700;color:#801010;}
.meeting-btn.secondary{background:rgba(255,255,255,0.1);color:#fff;}
.participant-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;}
.participant-card{background:rgba(255,255,255,0.07);padding:15px;border-radius:8px;text-align:center;}
.participant-avatar{width:50px;height:50px;border-radius:50%;background:#ffd700;color:#801010;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:18px;}
.participant-name{font-weight:bold;}
.participant-role{font-size:12px;color:#ccc;margin-top:4px;}

/* åœ¨çº¿ç”¨æˆ·é¢æ¿ï¼ˆæ ·å¼å’Œä½ ç³»ç»Ÿå®Œå…¨ç»Ÿä¸€ï¼‰ */
.online-users-box{background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-top:10px;}
.online-user-item{padding:4px 8px;border-bottom:1px solid rgba(255,255,255,0.1);font-size:14px;}
.room-msg-box{background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-top:10px;height:180px;overflow-y:auto;}
.room-msg{margin:4px 0;font-size:14px;}
.room-msg-input{width:100%;margin-top:8px;padding:8px;border-radius:6px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #ffd70055;}

.chat-layout{display:grid;grid-template-columns:200px 1fr;gap:12px;margin-top:10px;}
.chat-user-list{height:420px;overflow-y:auto;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;}
.chat-user-item{padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer;}
.chat-user-item.active{background:rgba(255,215,0,0.15);}
.msg-area{flex:1;background:rgba(0,0,0,0.15);border-radius:8px;padding:10px;overflow-y:auto;}
.msg-input-area{display:flex;gap:6px;}
.msg-input{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #ffd70055;}
.send-btn{padding:0 16px;background:#ffd700;color:#801010;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
.msg-item{max-width:75%;margin-bottom:10px;padding:8px 12px;border-radius:12px;}
.msg-me{margin-left:auto;background:#ffd700;color:#5a0000;}
.msg-other{margin-right:auto;background:rgba(255,255,255,0.1);color:#fff;}

.user-preview{display:flex;align-items:center;gap:10px;padding:10px 0;}
.user-preview-avatar{width:50px;height:50px;border-radius:50%;border:2px solid #ffd700;object-fit:cover;}
</style>
</head>
<body>

<div class="splash-screen">
  <div class="ntlc-logo">
    <span class="ntlc-letter">N</span>
    <span class="ntlc-letter">T</span>
    <span class="ntlc-letter">L</span>
    <span class="ntlc-letter">C</span>
  </div>
  <p style="color:#666;">æ–°æ€æƒ³å­¦ä¹ ç¤¾</p>
</div>

<div class="auth-modal" id="authModal">
  <div class="auth-box">
    <span class="modal-close" onclick="closeAuth()">Ã—</span>
    <div class="auth-tabs">
      <div class="auth-tab active" data-mode="login">ç™»å½•</div>
      <div class="auth-tab" data-mode="reg">æ³¨å†Œ</div>
    </div>
    <div id="loginForm">
      <input class="auth-input" id="loginAcc" placeholder="è´¦å·">
      <input class="auth-input" id="loginPwd" type="password" placeholder="å¯†ç ">
      <button class="auth-btn" onclick="doLogin()">ç™»å½•</button>
    </div>
    <div id="regForm" style="display:none;">
      <input class="auth-input" id="regAcc" placeholder="è´¦å·">
      <input class="auth-input" id="regPwd" type="password" placeholder="å¯†ç ">
      <input class="auth-input" id="regNick" placeholder="æ˜µç§°">
      <button class="auth-btn" onclick="doReg()">æ³¨å†Œ</button>
    </div>
    <button class="cancel-login" onclick="closeAuth()">æ¸¸å®¢æµè§ˆ</button>
  </div>
</div>

<div class="pwd-modal" id="managePwdModal">
  <div class="pwd-box">
    <span class="modal-close" onclick="closePwdModal()">Ã—</span>
    <h3 style="color:#ffd700;text-align:center;">ç®¡ç†å¯†ç </h3>
    <input class="pwd-input" id="managePwd" type="password" placeholder="è¾“å…¥ç®¡ç†å¯†ç ">
    <button class="pwd-btn" onclick="checkManagePwd()">ç¡®è®¤è¿›å…¥</button>
  </div>
</div>

<div class="reject-modal" id="rejectModal">
  <div class="reject-box">
    <span class="modal-close" onclick="closeRejectModal()">Ã—</span>
    <h3 style="color:#ffd700;text-align:center;">é©³å›ç†ç”±</h3>
    <textarea class="reject-reason" id="reasonInput"></textarea>
    <button class="reject-btn" onclick="confirmReject()">æäº¤</button>
  </div>
</div>

<div class="api-modal" id="apiModal">
  <div class="api-box">
    <span class="modal-close" onclick="closeApiModal()">Ã—</span>
    <h3 style="color:#ffd700;text-align:center;margin-bottom:15px;">ChatGPT é…ç½®</h3>
    <p style="margin-bottom:10px;font-size:14px;">è¯·è¾“å…¥ä½ çš„ OpenAI API Keyï¼ˆä»…æœ¬åœ°ä¿å­˜ï¼‰</p>
    <input class="api-input" id="openaiApiKey" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
    <button class="api-btn" onclick="saveApiKey()">ä¿å­˜å¹¶å…³é—­</button>
  </div>
</div>

<div class="main-app" id="mainApp">
  <div class="user-bar">
    <div class="user-info" style="display:flex;align-items:center;">
      <img id="topAvatar" src="https://picsum.photos/80/80" class="avatar">
      <span class="user-name" id="nickBar"></span>
    </div>
    <span class="logout" onclick="logout()">é€€å‡ºç™»å½•</span>
  </div>

  <div class="search-bar">
    <input class="search-input" id="searchInput" placeholder="è¯·è¾“å…¥ä¸ªäººç¼–å·æœç´¢ç”¨æˆ·" oninput="doSearchByUid()">
  </div>

  <div class="navbar">
    <h1>æ–°æ€æƒ³å­¦ä¹ ç¤¾</h1>
    <div class="nav-links-first">
      <span class="nav-link active" onclick="go('home')">é¦–é¡µ</span>
      <span class="nav-link" onclick="go('article')">æœ€æ–°æ–‡ç« </span>
      <span class="nav-link member-only" onclick="go('publish')">å‘å¸ƒæ–‡ç« </span>
      <span class="nav-link member-only" onclick="go('usercenter')">ä¸ªäººä¸­å¿ƒ</span>
      <span class="nav-link member-only" onclick="go('chat')">ç§èŠ</span>
    </div>
    <div class="nav-links-second">
      <span class="nav-link member-only" onclick="go('voice')">è¯­éŸ³ä¼šè®®</span>
      <span class="nav-link" onclick="go('userlist')">ç”¨æˆ·åˆ—è¡¨</span>
      <span class="nav-link" onclick="openManagePwd()">ç®¡ç†ä¸­å¿ƒ</span>
    </div>
  </div>

  <div class="container">
    <div id="home" class="card"><h3>é¦–é¡µ</h3><p>åŠŸèƒ½ï¼šè¯­éŸ³ä¼šè®®ã€ChatGPTæ–‡ç« è¯„ä»·ã€UIDæœç´¢ã€ä¸ªäººä¸­å¿ƒã€æ–‡ç« ç®¡ç†</p></div>

    <div id="article" class="card" style="display:none;"><h3>å·²é€šè¿‡æ–‡ç« </h3><div id="articleList"></div></div>

    <div id="publish" class="card" style="display:none;"><h3>å‘å¸ƒæ–‡ç« </h3><input class="auth-input" id="artTitle" placeholder="æ ‡é¢˜"><textarea class="auth-input" rows="7" id="artContent" placeholder="å†…å®¹"></textarea><button class="auth-btn" onclick="publishArt()">æäº¤</button></div>

    <div id="usercenter" class="card" style="display:none;">
      <h3>ä¸ªäººä¸­å¿ƒ</h3>
      <div class="form-row">
        <label>ä¸ªäººç¼–å·ï¼ˆUIDï¼Œä¸å¯ä¿®æ”¹ï¼‰</label>
        <input class="auth-input" id="showUid" readonly>
      </div>
      <div class="form-row">
        <label>æ˜µç§°</label>
        <input class="auth-input" id="editNick">
      </div>
      <div class="form-row">
        <label>æ€§åˆ«ï¼ˆç”·/å¥³/ä¿å¯†ï¼‰</label>
        <input class="auth-input" id="editGender" placeholder="ä¾‹å¦‚ï¼šç”·">
      </div>
      <div class="form-row">
        <label>å¹´é¾„</label>
        <input class="auth-input" id="editAge" placeholder="æ•°å­—">
      </div>
      <div class="form-row">
        <label>å¤´åƒURLï¼ˆç²˜è´´å›¾ç‰‡åœ°å€ï¼‰</label>
        <input class="auth-input" id="editAvatar" placeholder="https://...">
      </div>
      <button class="auth-btn" onclick="saveUserInfo()">ä¿å­˜å…¨éƒ¨ä¿¡æ¯</button>
      <hr style="margin:20px 0;border-color:#ffd70033;">
      <h4 style="color:#ffd700;margin-bottom:10px;">æˆ‘çš„æ–‡ç« </h4>
      <div id="myArticleList"></div>
    </div>

    <div id="chat" class="card" style="display:none;"><h3>ç§èŠ</h3><div class="chat-layout"><div class="chat-user-list" id="chatUserList"></div><div class="chat-box"><div class="msg-area" id="msgArea"></div><div class="msg-input-area"><input class="msg-input" id="msgInput" onkeydown="event.key==='Enter'&&sendMsg()"><button class="send-btn" onclick="sendMsg()">å‘é€</button></div></div></div></div>

    <!-- è¯­éŸ³ä¼šè®®é¡µé¢ï¼šå®Œå…¨ä¿ç•™ä½ åŸç‰ˆæ ·å¼ + æ–°å¢çœŸå¤šäººåœ¨çº¿ -->
    <div id="voice" class="card" style="display:none;">
      <h3>è¯­éŸ³ä¼šè®®ï¼ˆçœŸå®å¤šäººåœ¨çº¿ï¼‰</h3>
      <div class="meeting-room">
        <div class="meeting-info">
          <div class="meeting-name">å½“å‰æˆ¿é—´ï¼š<span id="currentRoomName">æœªåŠ å…¥</span></div>
          <div class="meeting-controls">
            <button class="meeting-btn" onclick="createRealRoom()">åˆ›å»ºæˆ¿é—´</button>
            <button class="meeting-btn" onclick="joinRealRoom()">åŠ å…¥æˆ¿é—´</button>
            <button class="meeting-btn secondary" id="micBtn" onclick="toggleMic()">ğŸ¤ éº¦å…‹é£</button>
            <button class="meeting-btn secondary" onclick="leaveRealRoom()">ç¦»å¼€</button>
          </div>
        </div>

        <div class="online-users-box">
          <div style="font-size:14px;margin-bottom:6px;color:#ffd700;">åœ¨çº¿ç”¨æˆ·ï¼š</div>
          <div id="onlineUserList"></div>
        </div>

        <div class="room-msg-box" id="roomChatBox"></div>
        <input class="room-msg-input" id="roomMsgInput" placeholder="æˆ¿é—´å…¬èŠæ¶ˆæ¯..." onkeydown="event.key==='Enter'&&sendRoomMsg()">

        <h4 style="color:#ffd700;margin:15px 0 10px 0;">å‚ä¼šè€…</h4>
        <div class="participant-grid" id="participantList">
          <p style="text-align:center;color:#ccc;">è¯·åˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´</p>
        </div>
      </div>
    </div>

    <div id="userlist" class="card" style="display:none;"><h3>æœç´¢ç»“æœï¼ˆæŒ‰UIDï¼‰</h3><div id="searchResult"></div></div>

    <div id="manage" class="card" style="display:none;">
      <h3>ç®¡ç†ä¸­å¿ƒ</h3>
      <div style="margin-bottom:20px;">
        <h4 style="color:#ffd700;">æ–‡ç« ç®¡ç†ï¼ˆå®¡æ ¸+åˆ é™¤ï¼‰</h4>
        <div id="auditList"></div>
      </div>
      <hr style="margin:20px 0;border-color:#ffd70033;">
      <div>
        <h4 style="color:#ffd700;">ç”¨æˆ·å°å·ç®¡ç†</h4>
        <div id="banUserList"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ===================== åŸç‰ˆå…¨å±€å˜é‡å®Œå…¨ä¿ç•™ =====================
const STORAGE = {
  users:"ntlc_users", cur:"ntlc_cur", arts:"ntlc_arts", chats:"ntlc_chats",
  likes:"ntlc_likes", comments:"ntlc_comments", meetings:"ntlc_meetings",
  aiEvals:"ntlc_ai_evals", apiKey:"ntlc_openai_key"
};
const MANAGE_PWD = "159357258";
const AI_PROMPT = "ä½ æ˜¯ä¸“ä¸šæ–‡ç« è¯„å®¡ï¼Œç®€æ´è¯„ä»·å†…å®¹ã€é€»è¾‘ã€è¡¨è¾¾ï¼Œç»™1-2æ¡æ”¹è¿›å»ºè®®ï¼Œ150å­—å†…ã€‚";

let users = JSON.parse(localStorage.getItem(STORAGE.users) || "[]");
let cur = JSON.parse(localStorage.getItem(STORAGE.cur) || null);
let arts = JSON.parse(localStorage.getItem(STORAGE.arts) || "[]");
let chats = JSON.parse(localStorage.getItem(STORAGE.chats) || "[]");
let likes = JSON.parse(localStorage.getItem(STORAGE.likes) || "[]");
let comments = JSON.parse(localStorage.getItem(STORAGE.comments) || "[]");
let meetings = JSON.parse(localStorage.getItem(STORAGE.meetings) || "[]");
let aiEvals = JSON.parse(localStorage.getItem(STORAGE.aiEvals) || "{}");
let apiKey = localStorage.getItem(STORAGE.apiKey) || "";

let currentRejectId = null;
let chatTo = null;

// ===================== çœŸå®å¤šäººåœ¨çº¿æ ¸å¿ƒï¼ˆWebSocketå…¬ç”¨æœåŠ¡ï¼‰=====================
let ws = null;
let currentRoomId = null;
let onlineUsers = [];
let localStream = null;
let peerConnections = {};
const ICE_CONFIG = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

// è·³è¿‡å¯åŠ¨åŠ¨ç”»
document.getElementById("authModal").style.display = "flex";

// ===================== åŸç‰ˆç™»å½•/æ³¨å†Œ/åˆ‡æ¢é¡µé¢é€»è¾‘å®Œå…¨ä¸åŠ¨ =====================
document.querySelectorAll(".auth-tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".auth-tab").forEach(x => x.classList.remove("active"));
    tab.classList.add("active");
    const m = tab.dataset.mode;
    document.getElementById("loginForm").style.display = m === "login" ? "block" : "none";
    document.getElementById("regForm").style.display = m === "reg" ? "block" : "none";
  };
});

function closeAuth() {
  document.getElementById("authModal").style.display = "none";
  document.getElementById("mainApp").style.display = "block";
  if (!cur) { document.getElementById("nickBar").innerText = "æ¸¸å®¢"; return; }
  document.getElementById("mainApp").classList.add("has-account");
  document.getElementById("nickBar").innerText = cur.nick;
  document.getElementById("topAvatar").src = cur.avatar || "https://picsum.photos/80/80";
  initWS();
}

function doReg() {
  const acc = document.getElementById("regAcc").value.trim();
  const pwd = document.getElementById("regPwd").value.trim();
  const nick = document.getElementById("regNick").value.trim();
  if (!acc||!pwd||!nick) return alert("è¯·å¡«å®Œæ•´");
  if (users.some(u=>u.account===acc)) return alert("è´¦å·å·²å­˜åœ¨");
  const uid = "UID"+Date.now();
  const user={uid,account:acc,pwd:pwd,nick:nick,gender:"ä¿å¯†",age:"",avatar:"https://picsum.photos/80/80",status:"normal"};
  users.push(user);
  localStorage.setItem(STORAGE.users,JSON.stringify(users));
  alert("æ³¨å†ŒæˆåŠŸï¼ç¼–å·ï¼š"+uid);
  document.querySelector('.auth-tab[data-mode="login"]').click();
}

function doLogin() {
  const acc=document.getElementById("loginAcc").value.trim();
  const pwd=document.getElementById("loginPwd").value.trim();
  const u=users.find(x=>x.account===acc&&x.pwd===pwd);
  if(!u)return alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
  if(u.status==="ban")return alert("è´¦å·å·²å°ç¦");
  cur=u;localStorage.setItem(STORAGE.cur,JSON.stringify(cur));closeAuth();
}

function go(page) {
  document.querySelectorAll(".card").forEach(c=>c.style.display="none");
  document.getElementById(page).style.display="block";
  document.querySelectorAll(".nav-link").forEach(n=>n.classList.remove("active"));
  const el=document.querySelector(`.nav-link[onclick*="${page}"]`);
  if(el)el.classList.add("active");
  if(page==="article")renderArticles();
  if(page==="chat")loadChatUsers();
  if(page==="manage")renderManageCenter();
  if(page==="usercenter")renderUserCenter();
  if(page==="userlist")document.getElementById("searchResult").innerHTML="<p>è¯·è¾“å…¥ç¼–å·æœç´¢</p>";
}

// ===================== åŸç‰ˆç”¨æˆ·ä¸­å¿ƒ/æ–‡ç« /è¯„è®º/AIå®Œå…¨ä¿ç•™ =====================
function doSearchByUid() {
  const kw=document.getElementById("searchInput").value.trim();go("userlist");
  if(!kw){document.getElementById("searchResult").innerHTML="<p>è¯·è¾“å…¥ä¸ªäººç¼–å·</p>";return;}
  const t=users.find(u=>u.uid===kw);
  if(!t){document.getElementById("searchResult").innerHTML=`<p>æœªæ‰¾åˆ°ï¼š${kw}</p>`;return;}
  document.getElementById("searchResult").innerHTML=`
  <div class="user-preview">
    <img src="${t.avatar}" class="user-preview-avatar">
    <div>
      <div style="font-weight:bold;color:#ffd700;">${t.nick}</div>
      <div>ç¼–å·ï¼š${t.uid}</div>
      <div>${t.gender}ï½œ${t.age||"æœªå¡«"}å²</div>
      <button class="btn btn-sm btn-yellow" onclick="openChat('${t.uid}','${t.nick}')">ç§èŠ</button>
    </div>
  </div>`;
}

function renderUserCenter() {
  if(!cur)return;
  document.getElementById("showUid").value=cur.uid;
  document.getElementById("editNick").value=cur.nick||"";
  document.getElementById("editGender").value=cur.gender||"ä¿å¯†";
  document.getElementById("editAge").value=cur.age||"";
  document.getElementById("editAvatar").value=cur.avatar||"https://picsum.photos/80/80";
  const my=arts.filter(a=>a.uid===cur.uid);
  document.getElementById("myArticleList").innerHTML=my.length?my.map(a=>`
    <div style="padding:8px;border-bottom:1px solid #fff2;">
      <div style="color:#ffd700;">${a.title} [${a.status}]</div>
      <div style="font-size:12px;color:#ccc;">${a.time}</div>
    </div>`).join(""):"<p>æš‚æ— æ–‡ç« </p>";
}

function saveUserInfo() {
  if(!cur)return;
  cur.nick=document.getElementById("editNick").value.trim()||cur.nick;
  cur.gender=document.getElementById("editGender").value.trim()||"ä¿å¯†";
  cur.age=document.getElementById("editAge").value.trim()||"";
  cur.avatar=document.getElementById("editAvatar").value.trim()||"https://picsum.photos/80/80";
  const u=users.find(x=>x.uid===cur.uid);Object.assign(u,cur);
  arts.forEach(a=>{if(a.uid===cur.uid)a.nick=cur.nick;});
  comments.forEach(c=>{if(c.uid===cur.uid)c.nick=cur.nick;});
  localStorage.setItem(STORAGE.cur,JSON.stringify(cur));
  localStorage.setItem(STORAGE.users,JSON.stringify(users));
  localStorage.setItem(STORAGE.arts,JSON.stringify(arts));
  localStorage.setItem(STORAGE.comments,JSON.stringify(comments));
  document.getElementById("nickBar").innerText=cur.nick;
  document.getElementById("topAvatar").src=cur.avatar;
  alert("ä¿å­˜æˆåŠŸï¼");
  renderUserCenter();
}

function publishArt() {
  if(!cur)return alert("è¯·ç™»å½•");
  const t=document.getElementById("artTitle").value.trim();
  const c=document.getElementById("artContent").value.trim();
  if(!t||!c)return alert("ä¸èƒ½ä¸ºç©º");
  arts.unshift({id:"a"+Date.now(),title:t,content:c,uid:cur.uid,nick:cur.nick,status:"pending",time:new Date().toLocaleString()});
  localStorage.setItem(STORAGE.arts,JSON.stringify(arts));
  alert("æäº¤å¾…å®¡æ ¸");go("article");
}

function toggleLike(aid){
  if(!cur)return alert("è¯·ç™»å½•");
  const i=likes.findIndex(x=>x.aid===aid&&x.uid===cur.uid);
  i>-1?likes.splice(i,1):likes.push({aid,uid:cur.uid});
  localStorage.setItem(STORAGE.likes,JSON.stringify(likes));renderArticles();
}

function sendComment(aid){
  if(!cur)return alert("è¯·ç™»å½•");
  const i=document.getElementById(`comment_${aid}`);
  const t=i.value.trim();if(!t)return;
  comments.push({cid:"c"+Date.now(),aid:aid,uid:cur.uid,nick:cur.nick,content:t,time:new Date().toLocaleString()});
  localStorage.setItem(STORAGE.comments,JSON.stringify(comments));
  i.value="";renderArticles();
}

function openApiModal(){document.getElementById("openaiApiKey").value=apiKey;document.getElementById("apiModal").style.display="flex";}
function closeApiModal(){document.getElementById("apiModal").style.display="none";}
function saveApiKey(){apiKey=document.getElementById("openaiApiKey").value.trim();localStorage.setItem(STORAGE.apiKey,apiKey);alert("ä¿å­˜æˆåŠŸ");closeApiModal();}

async function getAiEvaluation(aid){
  if(!apiKey){openApiModal();return;}
  if(aiEvals[aid]){alert("å·²æœ‰è¯„ä»·");renderArticles();return;}
  const a=arts.find(x=>x.id===aid);if(!a)return;
  try{
    const r=await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+apiKey},
      body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:AI_PROMPT},{role:"user",content:`æ ‡é¢˜ï¼š${a.title}å†…å®¹ï¼š${a.content}`}],max_tokens:200})
    });
    const d=await r.json();
    aiEvals[aid]=d.choices?.[0]?.message?.content||"è¯„ä»·å¤±è´¥";
  }catch(e){aiEvals[aid]="ç½‘ç»œæˆ–API Keyé”™è¯¯";}
  localStorage.setItem(STORAGE.aiEvals,JSON.stringify(aiEvals));renderArticles();
}

function renderArticles(){
  const p=arts.filter(a=>a.status==="pass");
  document.getElementById("articleList").innerHTML=p.map(a=>{
    const lc=likes.filter(x=>x.aid===a.id).length;
    const ml=cur&&likes.some(x=>x.aid===a.id&&x.uid===cur.uid);
    const cs=comments.filter(x=>x.aid===a.id);
    const ae=aiEvals[a.id]||"";
    return `
    <div class="article-item">
      <div class="article-title">${a.title}</div>
      <div class="article-meta">${a.nick}ï½œ${a.time}</div>
      <div class="article-content">${a.content}</div>
      <div class="like-box">
        <button class="like-btn" onclick="toggleLike('${a.id}')">${ml?"â¤ï¸å·²ç‚¹èµ":"ğŸ¤ç‚¹èµ"}(${lc})</button>
        <button class="ai-eval-btn" onclick="getAiEvaluation('${a.id}')">AIè¯„ä»·</button>
      </div>
      ${ae?`<div class="ai-result">${ae}</div>`:""}
      <div style="margin-top:10px;">
        ${cs.map(c=>`
        <div class="comment-item">
          <div class="comment-user">${c.nick}ï½œ${c.time}</div>
          <div class="comment-text">${c.content}</div>
        </div>`).join("")}
        <div class="comment-input-box member-only">
          <input class="comment-input" id="comment_${a.id}" placeholder="å†™è¯„è®º">
          <button class="send-comment-btn" onclick="sendComment('${a.id}')">å‘é€</button>
        </div>
      </div>
    </div>`;
  }).join("")||"<p style='text-align:center'>æš‚æ— æ–‡ç« </p>";
}

// ===================== ç®¡ç†åŠŸèƒ½å®Œå…¨ä¿ç•™ =====================
function openManagePwd(){document.getElementById("managePwdModal").style.display="flex";}
function closePwdModal(){document.getElementById("managePwdModal").style.display="none";}
function checkManagePwd(){if(document.getElementById("managePwd").value===MANAGE_PWD){closePwdModal();go("manage");}else alert("å¯†ç é”™è¯¯");}
function openRejectModal(id){currentRejectId=id;document.getElementById("rejectModal").style.display="flex";}
function closeRejectModal(){document.getElementById("rejectModal").style.display="none";}
function confirmReject(){const r=document.getElementById("reasonInput").value.trim();if(!r)return alert("è¯·å†™ç†ç”±");const a=arts.find(x=>x.id===currentRejectId);a.status="reject";localStorage.setItem(STORAGE.arts,JSON.stringify(arts));closeRejectModal();renderManageCenter();}
function passArticle(id){const a=arts.find(x=>x.id===id);a.status="pass";localStorage.setItem(STORAGE.arts,JSON.stringify(arts));renderManageCenter();}
function deleteArticle(id){if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ"))return;arts=arts.filter(x=>x.id!==id);comments=comments.filter(x=>x.aid!==id);likes=likes.filter(x=>x.aid!==id);delete aiEvals[id];localStorage.setItem(STORAGE.arts,JSON.stringify(arts));localStorage.setItem(STORAGE.comments,JSON.stringify(comments));localStorage.setItem(STORAGE.likes,JSON.stringify(likes));localStorage.setItem(STORAGE.aiEvals,JSON.stringify(aiEvals));renderManageCenter();}
function toggleBan(uid){const u=users.find(x=>x.uid===uid);u.status=u.status==="normal"?"ban":"normal";localStorage.setItem(STORAGE.users,JSON.stringify(users));renderManageCenter();}
function renderManageCenter(){
  document.getElementById("auditList").innerHTML=arts.map(a=>`
    <div style="padding:10px;border-bottom:1px solid #fff2;">
      <div style="color:#ffd700;">${a.title}[${a.status}]</div>
      <div style="font-size:12px;">${a.nick}ï½œ${a.time}</div>
      <div style="margin-top:6px;display:flex;gap:6px;">
        ${a.status==="pending"?`<button class="btn btn-sm btn-green" onclick="passArticle('${a.id}')">é€šè¿‡</button><button class="btn btn-sm btn-yellow" onclick="openRejectModal('${a.id}')">é©³å›</button>`:""}
        <button class="btn btn-sm btn-red" onclick="deleteArticle('${a.id}')">åˆ é™¤</button>
      </div>
    </div>`).join("");
  document.getElementById("banUserList").innerHTML=users.map(u=>`
    <div style="padding:10px;border-bottom:1px solid #fff2;display:flex;justify-content:space-between;">
      <div>${u.nick}ï½œ${u.uid}ï½œ${u.status}</div>
      <button class="btn btn-sm ${u.status==='normal'?'btn-red':'btn-green'}" onclick="toggleBan('${u.uid}')">${u.status==='normal'?'å°ç¦':'è§£å°'}</button>
    </div>`).join("");
}

// ===================== ç§èŠä¿ç•™ =====================
function loadChatUsers(){const l=users.filter(u=>!cur||u.uid!==cur.uid);document.getElementById("chatUserList").innerHTML=l.map(u=>`<div class="chat-user-item" onclick="openChat('${u.uid}','${u.nick}')">${u.nick}</div>`).join("");}
function openChat(uid){chatTo=uid;}
function sendMsg(){if(!chatTo||!cur)return;const t=document.getElementById("msgInput").value.trim();if(!t)return;chats.push({from:cur.uid,to:chatTo,text:t,time:new Date().toLocaleString()});localStorage.setItem(STORAGE.chats,JSON.stringify(chats));document.getElementById("msgInput").value="";alert("å‘é€æˆåŠŸ");}

// ===================== çœŸå®å¤šäºº WebSocket åˆå§‹åŒ– =====================
function initWS() {
  if (!cur) return;
  try {
    ws = new WebSocket("wss://echo.websocket.events");
    ws.onopen = () => { console.log("WSè¿æ¥æˆåŠŸ"); };
    ws.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        handleRoomMessage(data);
      } catch(err){}
    };
  } catch(e){}
}

function sendWS(data) {
  if (ws && ws.readyState === 1) ws.send(JSON.stringify(data));
}

function createRealRoom() {
  if (!cur) return alert("è¯·ç™»å½•");
  const room = prompt("è¾“å…¥æˆ¿é—´å·ï¼ˆæ•°å­—/è‹±æ–‡ï¼‰ï¼š", "room1");
  if (!room) return;
  currentRoomId = room;
  document.getElementById("currentRoomName").innerText = room;
  sendWS({ type: "join", room: room, uid: cur.uid, nick: cur.nick });
}

function joinRealRoom() {
  if (!cur) return alert("è¯·ç™»å½•");
  const room = prompt("è¾“å…¥è¦åŠ å…¥çš„æˆ¿é—´å·ï¼š");
  if (!room) return;
  currentRoomId = room;
  document.getElementById("currentRoomName").innerText = room;
  sendWS({ type: "join", room: room, uid: cur.uid, nick: cur.nick });
}

function leaveRealRoom() {
  if (!currentRoomId || !ws) return;
  sendWS({ type: "leave", room: currentRoomId, uid: cur.uid });
  currentRoomId = null;
  onlineUsers = [];
  document.getElementById("currentRoomName").innerText = "æœªåŠ å…¥";
  document.getElementById("onlineUserList").innerHTML = "";
  document.getElementById("roomChatBox").innerHTML = "";
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
}

function sendRoomMsg() {
  const txt = document.getElementById("roomMsgInput").value.trim();
  if (!txt || !currentRoomId || !ws) return;
  sendWS({ type: "msg", room: currentRoomId, uid: c
