<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新思想学习社 - 线上投稿平台</title>
  <style>
    /* 全局样式（修复一片红） */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      background-color: #f5f5f5; /* 浅灰背景，不再全红 */
      min-height: 100vh;
      color: #333;
      font-family: sans-serif;
      line-height: 1.6;
    }

    /* 登录注册弹窗 - 按钮绝对可点 */
    .auth-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .auth-box {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 420px;
      z-index: 100000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .auth-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: #f0f0f0;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }
    .auth-tab.active {
      background: #b81c1c;
      color: #fff;
      font-weight: bold;
    }
    .auth-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 6px;
      background: #f9f9f9;
      color: #333;
      border: 1px solid #ddd;
      outline: none;
    }
    .auth-btn {
      width: 100%;
      padding: 12px;
      border-radius: 6px;
      background: #b81c1c;
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer !important;
      outline: none;
    }
    .auth-tip {
      font-size: 14px;
      text-align: center;
      margin-top: 10px;
      color: #666;
    }
    .auth-tip span {
      color: #b81c1c;
      cursor: pointer;
    }

    /* 顶部用户栏 */
    .user-bar {
      background: #b81c1c;
      padding: 8px 15px;
      font-size: 14px;
      text-align: right;
      color: #fff;
    }
    .user-info {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    .user-name {
      font-weight: bold;
      color: #fff;
    }
    .user-link {
      color: #fff;
      margin-left: 8px;
      cursor: pointer;
      font-size: 13px;
    }
    .user-link:hover {
      color: #ffd700;
    }
    .badge {
      background: #ffd700;
      color: #b81c1c;
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 10px;
      margin-left: 3px;
    }

    /* 导航 */
    .navbar {
      background: #b81c1c;
      padding: 15px;
      position: sticky;
      top: 0;
      z-index: 100;
      text-align: center;
    }
    .navbar h1 {
      color: #fff;
      font-size: 22px;
      margin-bottom: 10px;
    }
    .nav-links {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .nav-link {
      color: #fff;
      text-decoration: none;
      font-size: 15px;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .nav-link:hover, .nav-link.active {
      color: #ffd700;
      background: rgba(255,255,255,0.1);
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 15px;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .card h2, .card h3 {
      color: #b81c1c;
      text-align: center;
      margin-bottom: 15px;
    }
    .tip-text {
      color: #b81c1c;
      font-size: 14px;
      text-align: center;
      margin: 8px 0;
    }
    .search-bar {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      background: #f9f9f9;
      color: #333;
      border: 1px solid #ddd;
      outline: none;
      margin-bottom: 10px;
    }

    /* 按钮 */
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      outline: none;
    }
    .btn-primary {
      background: #b81c1c;
      color: #fff;
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }
    .btn-red {
      background: #c81010;
      color: #fff;
    }
    .btn-green {
      background: #28a050;
      color: #fff;
    }
    .btn-blue {
      background: #1a73e8;
      color: #fff;
    }
    .btn-gray {
      background: #666;
      color: #fff;
    }

    .user-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .user-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .user-item-name {
      font-weight: bold;
      color: #b81c1c;
    }
    .highlight {
      background: #b81c1c;
      color: #fff;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* 聊天 */
    .chat-container {
      height: 400px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .chat-message {
      margin-bottom: 10px;
      max-width: 75%;
    }
    .chat-me {
      margin-left: auto;
      background: #b81c1c;
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px 12px 4px 12px;
    }
    .chat-other {
      margin-right: auto;
      background: #fff;
      color: #333;
      padding: 8px 12px;
      border-radius: 12px 12px 12px 4px;
      border: 1px solid #ddd;
    }
    .chat-time {
      font-size: 10px;
      color: #999;
      text-align: right;
      margin-top: 2px;
    }
    .chat-withdraw {
      font-size: 10px;
      color: #b81c1c;
      cursor: pointer;
      margin-left: 5px;
    }
    .chat-img {
      max-width: 150px;
      border-radius: 8px;
      margin: 5px 0;
      cursor: pointer;
    }
    .chat-input {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      background: #f9f9f9;
      color: #333;
      border: 1px solid #ddd;
      outline: none;
    }
    .file-input {
      display: none;
    }

    /* 语音房间 */
    .voice-room {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .voice-member {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: #fff;
      border-radius: 6px;
      margin-bottom: 6px;
      border: 1px solid #eee;
    }
    .voice-controls {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .mic-status {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .mic-on {
      background: #28a050;
      color: #fff;
    }
    .mic-off {
      background: #c81010;
      color: #fff;
    }
    .room-host-tag {
      background: #b81c1c;
      color: #fff;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* 页面切换 */
    .page-content {
      display: none;
    }
    .page-content.active {
      display: block;
    }
    .article-detail {
      display: none;
    }
    .article-detail.active {
      display: block;
    }
    .back-btn {
      background: #b81c1c;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    footer {
      text-align: center;
      margin: 30px 0;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>

<!-- 登录注册弹窗 -->
<div id="authModal" class="auth-modal">
  <div class="auth-box">
    <div class="auth-tabs">
      <div class="auth-tab active" data-mode="login">登录</div>
      <div class="auth-tab" data-mode="register">注册</div>
    </div>
    <div id="loginForm">
      <input class="auth-input" id="loginAccount" placeholder="手机号/QQ/微信">
      <input class="auth-input" id="loginPwd" type="password" placeholder="密码">
      <button class="auth-btn" onclick="doLogin()">登录</button>
      <div class="auth-tip">没有账号？<span onclick="switchAuth('register')">注册</span></div>
    </div>
    <div id="registerForm" style="display:none;">
      <input class="auth-input" id="regAccount" placeholder="账号(手机号/QQ/微信)">
      <input class="auth-input" id="regPwd" type="password" placeholder="密码">
      <input class="auth-input" id="regNickname" placeholder="昵称">
      <button class="auth-btn" onclick="doRegister()">注册</button>
      <div class="auth-tip">已有账号？<span onclick="switchAuth('login')">登录</span></div>
    </div>
  </div>
</div>

<!-- 用户栏 -->
<div class="user-bar" id="userBar" style="display:none;">
  <div class="user-info">
    <img id="barAvatar" class="avatar" src="https://picsum.photos/64/64">
    <span id="barName" class="user-name"></span>
    <span class="user-link" onclick="goPage('profile')">个人中心</span>
    <span class="user-link" onclick="goPage('userList')">用户列表</span>
    <span class="user-link" onclick="goPage('chatList')">私信 <span id="chatUnread" class="badge" style="display:none;">●</span></span>
    <span class="user-link" onclick="goPage('voice')">语音会议</span>
    <span class="user-link" onclick="logout()">退出</span>
  </div>
</div>

<!-- 导航 -->
<nav class="navbar">
  <h1>新思想学习社</h1>
  <div class="nav-links">
    <a class="nav-link active" onclick="goPage('home')">首页</a>
    <a class="nav-link" onclick="goPage('latest')">文章</a>
    <a class="nav-link" onclick="goPage('submit')">投稿</a>
    <a class="nav-link" onclick="goPage('audit')">审核</a>
    <a class="nav-link" onclick="goPage('adminManage')">管理员管理</a>
  </div>
</nav>

<div class="container">

  <!-- 首页 -->
  <div id="home" class="page-content active">
    <div class="card">
      <h2>新思想学习社</h2>
      <p>欢迎来到线上投稿平台。本社致力于理论学习、征文投稿、交流分享。</p>
    </div>
  </div>

  <!-- 最新文章 -->
  <div id="latest" class="page-content">
    <div class="card">
      <h3>最新已通过文章</h3>
      <ul id="postList"></ul>
    </div>
  </div>

  <!-- 文章详情 -->
  <div id="articleContainer" class="article-detail">
    <div class="card">
      <button class="back-btn" onclick="closeArticle()">← 返回</button>
      <h2 id="articleTitle"></h2>
      <div id="articleAuthor" style="color:#666; text-align:center; margin-bottom:10px;"></div>
      <div class="article-content" id="articleContent"></div>
      <div class="comment-section">
        <h3 style="color:#b81c1c; margin:15px 0;">评论</h3>
        <textarea id="commentInput" style="width:100%; padding:10px; border-radius:6px; background:#f9f9f9; color:#333;" rows="3" placeholder="文明发言"></textarea>
        <button class="btn btn-primary" onclick="submitComment()" style="margin-top:8px;">发表</button>
        <div id="commentList" style="margin-top:15px;"></div>
      </div>
    </div>
  </div>

  <!-- 投稿 -->
  <div id="submit" class="page-content">
    <div class="card">
      <h3>我要投稿</h3>
      <div class="tip-text">寒暑假随时可投，平时周五、周六</div>
      <div class="tip-text" id="timeTip"></div>
      <input id="newPostTitle" class="auth-input" placeholder="标题">
      <textarea id="newPostContent" class="auth-input" rows="6" placeholder="内容"></textarea>
      <button class="auth-btn" id="publishBtn" onclick="publishArticle()">提交投稿</button>
    </div>
    <div class="card">
      <h3>我的投稿记录</h3>
      <div id="userPostList"></div>
    </div>
  </div>

  <!-- 审核 -->
  <div id="audit" class="page-content">
    <div class="card">
      <h3>文章审核</h3>
      <div id="auditList"></div>
    </div>
  </div>

  <!-- 管理员管理 -->
  <div id="adminManage" class="page-content">
    <div class="card">
      <h3>管理员管理（总管理员专属）</h3>
      <div id="userListForAdmin"></div>
    </div>
  </div>

  <!-- 个人主页 -->
  <div id="profile" class="page-content">
    <div class="card">
      <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
        <img id="profileAvatar" src="https://picsum.photos/80/80" style="width:80px; height:80px; border-radius:50%; border:3px solid #b81c1c;">
        <div>
          <div style="font-size:22px; font-weight:bold; color:#b81c1c;" id="profileName"></div>
          <div style="color:#666;" id="profileRole"></div>
          <div style="margin-top:5px;">
            <span id="followCount" style="margin-right:10px;">关注：0</span>
            <span id="followerCount">粉丝：0</span>
          </div>
        </div>
      </div>
      <input class="auth-input" id="editNick" placeholder="昵称">
      <input class="auth-input" id="editAvatar" placeholder="头像链接">
      <button class="auth-btn" onclick="saveProfile()">保存资料</button>
    </div>
  </div>

  <!-- 用户列表 -->
  <div id="userList" class="page-content">
    <div class="card">
      <h3>全部用户</h3>
      <input class="search-bar" id="userSearch" placeholder="搜索账号/昵称/UID" oninput="renderAllUsers()">
      <div id="allUserList"></div>
    </div>
  </div>

  <!-- 私信列表 -->
  <div id="chatList" class="page-content">
    <div class="card">
      <h3>私信列表</h3>
      <div id="chatUserList"></div>
    </div>
  </div>

  <!-- 私信聊天 -->
  <div id="chatWindow" class="page-content">
    <div class="card">
      <button class="back-btn" onclick="goPage('chatList')">← 返回私信列表</button>
      <h3 id="chatTargetName"></h3>
      <div class="chat-container" id="chatBox"></div>
      <div class="chat-input">
        <input type="file" id="chatImgFile" class="file-input" accept="image/*" onchange="sendChatImage()">
        <button class="btn btn-sm btn-blue" onclick="document.getElementById('chatImgFile').click()">图片</button>
        <input id="chatInput" placeholder="输入消息">
        <button class="btn btn-primary" onclick="sendChat()">发送</button>
      </div>
    </div>
  </div>

  <!-- 语音会议 -->
  <div id="voice" class="page-content">
    <div class="card">
      <h3>语音会议房间</h3>
      <input class="search-bar" id="roomSearch" placeholder="搜索房间名" oninput="renderRoomList()">
      <div style="margin-bottom:15px;">
        <input class="auth-input" id="roomName" placeholder="房间名" style="margin-bottom:8px;">
        <button class="btn btn-primary" onclick="createRoom()">创建语音房间</button>
      </div>
      <div id="roomList"></div>
    </div>

    <div id="roomView" class="page-content">
      <div class="card">
        <button class="back-btn" onclick="leaveRoom()">← 离开会议</button>
        <h3 id="currentRoomName"></h3>
        <div class="voice-room">
          <div><strong>房间成员（麦克风状态）：</strong></div>
          <div id="roomMembers" style="margin-top:10px;"></div>
          <div class="voice-controls">
            <button class="btn btn-green" onclick="toggleMic()" id="micBtn">开启麦克风</button>
            <button class="btn btn-blue" onclick="muteAll()" id="muteAllBtn" style="display:none;">全员静音</button>
            <button class="btn btn-gray" onclick="unmuteAll()" id="unmuteAllBtn" style="display:none;">解除全员静音</button>
            <button class="btn btn-red" onclick="dismissRoom()" id="dismissBtn" style="display:none;">结束会议（解散）</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<footer>新思想学习社 © 2026</footer>

<script>
// 全局配置
const SUPER_ADMIN = "admin";
const LOCAL_KEYS = {
  users: "nt_users",
  articles: "nt_articles",
  comments: "nt_comments",
  admins: "nt_admins",
  current: "nt_current",
  follow: "nt_follow",
  chat: "nt_chat",
  voiceRooms: "nt_voice",
};

// 本地存储工具
function get(key) {
  try {
    return JSON.parse(localStorage.getItem(key)) || [];
  } catch (e) {
    return [];
  }
}
function set(key, val) {
  localStorage.setItem(key, JSON.stringify(val || []));
}

// 全局数据
let users = get(LOCAL_KEYS.users);
let articles = get(LOCAL_KEYS.articles);
let comments = get(LOCAL_KEYS.comments);
let admins = get(LOCAL_KEYS.admins);
let currentUser = get(LOCAL_KEYS.current);

let followData = get(LOCAL_KEYS.follow);
let chatData = get(LOCAL_KEYS.chat);
let voiceRooms = get(LOCAL_KEYS.voiceRooms);

let currentChatUid = null;
let currentRoomId = null;
let currentArtId = null;
let localStream = null;
let micOn = false;

// 登录注册切换
function switchAuth(mode) {
  document.querySelectorAll(".auth-tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`[data-mode="${mode}"]`).classList.add("active");
  document.getElementById("loginForm").style.display = mode === "login" ? "block" : "none";
  document.getElementById("registerForm").style.display = mode === "register" ? "block" : "none";
}

// 注册（防重复：一个账号只能注册一次）
function doRegister() {
  const account = document.getElementById("regAccount").value.trim();
  const pwd = document.getElementById("regPwd").value.trim();
  const nick = document.getElementById("regNickname").value.trim();

  if (!account || !pwd || !nick) {
    alert("请完整填写账号、密码、昵称");
    return;
  }

  const exists = users.some(u => u.account === account);
  if (exists) {
    alert("该账号已注册，禁止重复注册，请直接登录！");
    switchAuth("login");
    return;
  }

  const user = {
    uid: "u" + Date.now(),
    account: account,
    pwd: pwd,
    nick: nick,
    avatar: "https://picsum.photos/80/80",
    role: account === SUPER_ADMIN ? "super" : "user"
  };

  users.push(user);
  set(LOCAL_KEYS.users, users);
  alert("注册成功，请登录");
  switchAuth("login");
}

// 登录
function doLogin() {
  const account = document.getElementById("loginAccount").value.trim();
  const pwd = document.getElementById("loginPwd").value.trim();
  const u = users.find(x => x.account === account && x.pwd === pwd);
  if (!u) {
    alert("账号或密码错误");
    return;
  }
  currentUser = u;
  set(LOCAL_KEYS.current, currentUser);
  document.getElementById("authModal").style.display = "none";
  initAfterLogin();
}

// 退出登录
function logout() {
  currentUser = null;
  set(LOCAL_KEYS.current, null);
  location.reload();
}

// 权限判断
function isLogin() { return !!currentUser; }
function isSuper() { return isLogin() && currentUser.role === "super"; }
function isAdminUser() {
  if (!isLogin()) return false;
  if (isSuper()) return true;
  return admins.includes(currentUser.uid);
}

// 页面切换
function goPage(id) {
  document.querySelectorAll(".page-content").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".nav-link").forEach(n => n.classList.remove("active"));
  const target = document.getElementById(id);
  if (target) target.classList.add("active");
  const nav = document.querySelector(`.nav-link[onclick="goPage('${id}')"]`);
  if (nav) nav.classList.add("active");
  document.getElementById("articleContainer").classList.remove("active");

  if (id === "chatList") renderChatList();
  if (id === "userList") renderAllUsers();
  if (id === "profile") loadProfile();
  if (id === "adminManage") renderAdminManage();
  if (id === "voice") renderRoomList();
  if (id === "audit") renderAudit();
  if (id === "latest") renderArticles();
}

// 关注
function follow(uid) {
  if (!isLogin() || uid === currentUser.uid) return;
  const exists = followData.some(f => f.from === currentUser.uid && f.to === uid);
  if (exists) {
    followData = followData.filter(f => !(f.from === currentUser.uid && f.to === uid));
  } else {
    followData.push({ from: currentUser.uid, to: uid });
  }
  set(LOCAL_KEYS.follow, followData);
  renderAllUsers();
  loadProfile();
}
function getFollow(uid) { return followData.filter(f => f.from === uid).length; }
function getFollower(uid) { return followData.filter(f => f.to === uid).length; }
function isFollowing(uid) { return followData.some(f => f.from === currentUser.uid && f.to === uid); }

// 用户列表搜索
function renderAllUsers() {
  const kw = (document.getElementById("userSearch").value || "").toLowerCase().trim();
  const el = document.getElementById("allUserList");
  let html = "";
  users.forEach(u => {
    if (u.uid === currentUser?.uid) return;
    const match = !kw ||
      u.uid.toLowerCase().includes(kw) ||
      u.nick.toLowerCase().includes(kw) ||
      u.account.toLowerCase().includes(kw);
    if (!match) return;
    const followed = isFollowing(u.uid);
    let nickShow = u.nick;
    let accShow = u.account;
    let uidShow = u.uid;
    if (kw) {
      const reg = new RegExp(`(${kw})`, "gi");
      nickShow = nickShow.replace(reg, '<span class="highlight">$1</span>');
      accShow = accShow.replace(reg, '<span class="highlight">$1</span>');
      uidShow = uidShow.replace(reg, '<span class="highlight">$1</span>');
    }
    html += `
      <div class="user-item">
        <div class="user-left">
          <img src="${u.avatar}" class="avatar">
          <div>
            <div class="user-item-name">${nickShow}</div>
            <div style="font-size:12px;color:#666;">账号：${accShow}｜UID：${uidShow}</div>
          </div>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-sm btn-primary" onclick="follow('${u.uid}')">${followed ? '已关注' : '关注'}</button>
          <button class="btn btn-sm btn-green" onclick="openChat('${u.uid}')">私信</button>
        </div>
      </div>
    `;
  });
  el.innerHTML = html || '<div style="text-align:center;color:#666;">无匹配用户</div>';
}

// 私信
function openChat(uid) {
  if (!isLogin() || uid === currentUser.uid) return;
  currentChatUid = uid;
  const u = users.find(x => x.uid === uid);
  document.getElementById("chatTargetName").innerText = "与 " + (u?.nick || "用户") + " 聊天";
  goPage("chatWindow");
  renderChatBox();
  markChatRead();
}
function sendChat() {
  const txt = document.getElementById("chatInput").value.trim();
  if (!txt || !currentChatUid) return;
  chatData.push({
    id: "c" + Date.now(),
    from: currentUser.uid,
    to: currentChatUid,
    content: txt,
    type: "text",
    time: new Date().toLocaleString(),
    read: false
  });
  set(LOCAL_KEYS.chat, chatData);
  document.getElementById("chatInput").value = "";
  renderChatBox();
}
function sendChatImage() {
  const file = document.getElementById("chatImgFile").files[0];
  if (!file || !currentChatUid) return;
  const reader = new FileReader();
  reader.onload = e => {
    chatData.push({
      id: "c" + Date.now(),
      from: currentUser.uid,
      to: currentChatUid,
      content: e.target.result,
      type: "image",
      time: new Date().toLocaleString(),
      read: false
    });
    set(LOCAL_KEYS.chat, chatData);
    renderChatBox();
  };
  reader.readAsDataURL(file);
}
function withdrawChat(id) {
  if (!confirm("确定撤回这条消息？")) return;
  chatData = chatData.filter(m => m.id !== id);
  set(LOCAL_KEYS.chat, chatData);
  renderChatBox();
}
function renderChatBox() {
  const box = document.getElementById("chatBox");
  const list = chatData.filter(m =>
    (m.from === currentUser.uid && m.to === currentChatUid) ||
    (m.from === currentChatUid && m.to === currentUser.uid)
  ).sort((a, b) => a.id.localeCompare(b.id));
  let html = "";
  list.forEach(m => {
    const me = m.from === currentUser.uid;
    const withdrawBtn = me ? `<span class="chat-withdraw" onclick="withdrawChat('${m.id}')">撤回</span>` : "";
    const content = m.type === "image"
      ? `<img src="${m.content}" class="chat-img" onclick="window.open(this.src)">`
      : m.content;
    html += `
      <div class="chat-message ${me ? 'chat-me' : 'chat-other'}">
        <div>${content} ${withdrawBtn}</div>
        <div class="chat-time">${m.time}</div>
      </div>
    `;
  });
  box.innerHTML = html;
  box.scrollTop = box.scrollHeight;
}
function renderChatList() {
  const map = {};
  chatData.forEach(m => {
    const o = m.from === currentUser.uid ? m.to : m.from;
    if (!map[o]) map[o] = { uid: o, unread: 0 };
    if (m.to === currentUser.uid && !m.read) map[o].unread++;
  });
  const arr = Object.values(map);
  const el = document.getElementById("chatUserList");
  let html = "";
  arr.forEach(x => {
    const u = users.find(i => i.uid === x.uid);
    if (!u) return;
    html += `
      <div class="user-item" onclick="openChat('${u.uid}')">
        <div class="user-left">
          <img src="${u.avatar}" class="avatar">
          <div class="user-item-name">${u.nick}</div>
          ${x.unread > 0 ? '<span class="badge">新</span>' : ''}
        </div>
      </div>
    `;
  });
  el.innerHTML = html || '<div style="text-align:center;color:#666;">暂无私信</div>';
  document.getElementById("chatUnread").style.display =
    chatData.some(m => m.to === currentUser.uid && !m.read) ? "inline" : "none";
}
function markChatRead() {
  chatData.forEach(m => {
    if (m.from === currentChatUid && m.to === currentUser.uid) m.read = true;
  });
  set(LOCAL_KEYS.chat, chatData);
  renderChatList();
}

// 语音会议
function createRoom() {
  const name = document.getElementById("roomName").value.trim() || "未命名房间";
  const room = {
    id: "r" + Date.now(),
    name: name,
    owner: currentUser.uid,
    members: [{ uid: currentUser.uid, mic: true }],
    globalMuted: false
  };
  voiceRooms.push(room);
  set(LOCAL_KEYS.voiceRooms, voiceRooms);
  enterRoom(room.id);
}
function renderRoomList() {
  const kw = (document.getElementById("roomSearch").value || "").toLowerCase().trim();
  const el = document.getElementById("roomList");
  let html = "";
  voiceRooms.forEach(r => {
    if (kw && !r.name.toLowerCase().includes(kw)) return;
    html += `
      <div class="user-item">
        <div class="user-left">
          <div class="user-item-name">${r.name}（${r.members.length}人）</div>
        </div>
        <button class="btn btn-sm btn-primary" onclick="enterRoom('${r.id}')">进入</button>
      </div>
    `;
  });
  el.innerHTML = html || '<div style="text-align:center;color:#666;">暂无房间</div>';
}
async function enterRoom(rid) {
  currentRoomId = rid;
  const r = voiceRooms.find(x => x.id === rid);
  if (!r) return;
  const member = r.members.find(m => m.uid === currentUser.uid);
  if (!member) r.members.push({ uid: currentUser.uid, mic: true });
  set(LOCAL_KEYS.voiceRooms, voiceRooms);
  document.getElementById("currentRoomName").innerText = r.name;
  renderRoomMembers();
  goPage("roomView");
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    micOn = true;
    localStream.getAudioTracks()[0].enabled = micOn;
    updateSelfMicState(micOn);
    updateRoomControlUI();
  } catch (e) {
    alert("麦克风权限被拒绝，请允许麦克风访问");
    micOn = false;
  }
}
function renderRoomMembers() {
  const r = voiceRooms.find(x => x.id === currentRoomId);
  if (!r) return;
  const el = document.getElementById("roomMembers");
  let html = "";
  r.members.forEach(m => {
    const u = users.find(x => x.uid === m.uid);
    if (!u) return;
    const isHost = r.owner === m.uid;
    const micText = m.mic ? "开启" : "关闭";
    const micClass = m.mic ? "mic-on" : "mic-off";
    const hostTag = isHost ? '<span class="room-host-tag">房主</span>' : "";
    const muteBtn = (r.owner === currentUser.uid && !isHost)
      ? `<button class="btn btn-sm btn-red" onclick="toggleUserMic('${m.uid}')">${m.mic ? '禁言' : '解除'}</button>`
      : "";
    html += `
      <div class="voice-member">
        <img src="${u.avatar}" class="avatar">
        <div>
          <div>${u.nick} ${hostTag}</div>
          <div class="mic-status ${micClass}">麦：${micText}</div>
        </div>
        ${muteBtn}
      </div>
    `;
  });
  el.innerHTML = html;
}
function updateRoomControlUI() {
  const r = voiceRooms.find(x => x.id === currentRoomId);
  if (!r) return;
  const isHost = r.owner === currentUser.uid;
  document.getElementById("muteAllBtn").style.display = isHost ? "inline-block" : "none";
  document.getElementById("unmuteAllBtn").style.display = isHost ? "inline-block" : "none";
  document.getElementById("dismissBtn").style.display = isHost ? "inline-block" : "none";
  document.getElementById("micBtn").innerText = micOn ? "关闭麦克风" : "开启麦克风";
}
function toggleMic() {
  if (!localStream) return;
  micOn = !micOn;
  localStream.getAudioTracks()[0].enabled = micOn;
  updateSelfMicState(micOn);
  updateRoomControlUI();
}
function updateSelfMicState(state) {
  const r = voiceRooms.find(x => x.id === currentRoomId);
  if (!r) return;
  const m = r.members.find(x => x.uid === currentUser.uid);
  if (m) m.mic = state;
  set(LOCAL_KEYS.voiceRooms, voiceRooms);
  renderRoomMembers();
}
function toggleUserMic(uid) {
  const r = voiceRooms.find(x => x.id === currentRoomId);
  if (!r || r.owner !== currentUser.uid) return;
  const m = r.members.find(x => x.uid === uid);
  if (m) m.mic = !m.mic;
  set(LOCAL_KEYS.voiceRooms, voiceRooms);
  renderRoomMembers();
}
function muteAll() {
  const r = voiceRooms.find(x => x.id === currentRoomId);
  if (!r || r.owner !== currentUser.uid) return;
  r.members.forEach(m => { if (m.uid !== currentUser.uid) m.mic = false; });
  r.globalMuted = true;
  set(LOCAL_KEYS.voiceRooms, voiceRooms);
  renderRoomMembers();
}
function unmuteAll() {
  const r = voiceRooms.find(x => x.id === currentRoomId);
  if (!r || r.owner !== currentUser.uid) return;
  r.members.forEach(m => m.mic = true);
  r.globalMuted = false;
  set(LOCAL_KEYS.voiceRooms, voiceRooms);
  renderRoomMembers();
}
function dismissRoom() {
  if (!confirm("确定结束并解散整个会议？")) return;
  voiceRooms = voiceRooms.filter(x => x.id !== currentRoomId);
  set(LOCAL_KEYS.voiceRooms, voiceRooms);
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  goPage("voice");
}
function leaveRoom() {
  const r = voiceRooms.find(x => x.id === currentRoomId);
  if (!r) return;
  r.members = r.members.filter(m => m.uid !== currentUser.uid);
  if (r.members.length === 0) voiceRooms = voiceRooms.filter(x => x.id !== currentRoomId);
  set(LOCAL_KEYS.voiceRooms, voiceRooms);
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  goPage("voice");
}

// 投稿与审核
function canPost() {
  const now = new Date();
  const m = now.getMonth() + 1;
  const d = now.getDate();
  const day = now.getDay();
  const md = `${m}-${d}`;
  const vacation = (md >= '7-1' && md <= '8-31') || (md >= '1-15' && md <= '2-28');
  if (
