<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–°æ€æƒ³å­¦ä¹ ç¤¾</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{background:#b81c1c;color:#fff;font-family:sans-serif;line-height:1.6;overflow:hidden;height:100vh;}

/* å¼€åœºåŠ¨ç”» */
.splash-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999999;animation:splashFade 2.5s ease forwards;animation-delay:3s;}
.ntlc-logo{display:flex;gap:12px;font-size:80px;font-weight:900;margin-bottom:40px;}
.ntlc-letter{opacity:0;transform:scale(0.5);animation:letterPop 0.6s ease forwards;}
.ntlc-letter:nth-child(1){color:#4285F4;animation-delay:0.2s;}
.ntlc-letter:nth-child(2){color:#EA4335;animation-delay:0.4s;}
.ntlc-letter:nth-child(3){color:#FBBC05;animation-delay:0.6s;}
.ntlc-letter:nth-child(4){color:#34A853;animation-delay:0.8s;}
@keyframes letterPop{0%{opacity:0;transform:scale(0.5);}70%{opacity:1;transform:scale(1.1);}100%{opacity:1;transform:scale(1);}}
@keyframes splashFade{0%{opacity:1;}100%{opacity:0;visibility:hidden;}}

/* ç™»å½•å¼¹çª— */
.auth-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(80,0,0,0.8);z-index:9999;display:none;align-items:center;justify-content:center;animation:fadeIn 0.3s forwards;}
@keyframes fadeIn{0%{opacity:0;}100%{opacity:1;}}
.modal-close{position:absolute;top:15px;right:15px;font-size:24px;color:#ffd700;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;cursor:pointer;}
.auth-box{background:#801010;padding:30px;border-radius:12px;width:90%;max-width:420px;animation:popIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275) forwards;transform:scale(0);}
@keyframes popIn{0%{transform:scale(0);}70%{transform:scale(1.05);}100%{transform:scale(1);}}
.auth-tabs{display:flex;gap:10px;margin-bottom:20px;}
.auth-tab{flex:1;padding:12px;text-align:center;background:rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;}
.auth-tab.active{background:#ffd700;color:#5a0000;font-weight:bold;}
.auth-input{width:100%;padding:14px;margin-bottom:12px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,215,0,0.4);outline:none;}
.auth-btn{width:100%;padding:14px;border-radius:8px;background:#ffd700;color:#5a0000;font-weight:bold;border:none;cursor:pointer;}
.cancel-login{width:100%;margin-top:10px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.1);color:#ffd700;border:1px solid #ffd700;cursor:pointer;}

/* ä¸»ä½“ */
.main-app{display:none;overflow:auto;height:100vh;padding-bottom:20px;}
.user-bar{background:#801010;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;}
.user-info{display:flex;align-items:center;gap:8px;}
.avatar{width:32px;height:32px;border-radius:50%;border:2px solid #ffd700;}
.user-name{color:#ffd700;font-weight:bold;}
.logout{color:#fff;cursor:pointer;}

/* æœç´¢æ¡†ï¼ˆæœç´¢ç”¨æˆ·ï¼‰ */
.search-bar{background:#801010;padding:8px 15px;text-align:center;}
.search-input{width:90%;max-width:400px;padding:10px 14px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #ffd70066;outline:none;}

/* å¯¼èˆª */
.navbar{background:#801010;padding:12px 10px;text-align:center;position:sticky;top:0;z-index:10;border-bottom:1px solid #ffd70033;}
.nav-links{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-top:8px;}
.nav-link{color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;transition:0.2s;}
.nav-link.active{background:#ffd700;color:#801010;font-weight:bold;}

.container{max-width:800px;margin:0 auto;padding:15px 10px;}
.card{background:#801010;padding:20px;border-radius:12px;margin-bottom:15px;}
.card h3{color:#ffd700;text-align:center;margin-bottom:15px;}

/* æƒé™ */
.member-only{display:none;}
.has-account .member-only{display:inline-block;}
.admin-only{display:none;}
.is-admin .admin-only{display:inline-block;}
.root-only{display:none;}
.is-root .root-only{display:inline-block;}

/* æ–‡ç«  */
.article-item{padding:12px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:10px;}
.article-title{color:#ffd700;font-weight:bold;font-size:17px;}
.article-meta{font-size:12px;color:#ccc;margin:4px 0;}
.article-content{color:#eee;font-size:15px;line-height:1.7;}

/* æŒ‰é’® */
.btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-weight:bold;margin-right:4px;}
.btn-sm{padding:4px 8px;font-size:12px;}
.btn-green{background:#28a050;color:#fff;}
.btn-red{background:#c81010;color:#fff;}
.btn-yellow{background:#ffc107;color:#222;}
.btn-gray{background:#666;color:#fff;}

/* ç§èŠ + å·²è¯»æœªè¯» */
.chat-layout{display:grid;grid-template-columns:200px 1fr;gap:12px;margin-top:10px;}
.chat-user-list{height:420px;overflow-y:auto;background:rgba(255,255,255,0.05);border-radius:8px;padding:8px;}
.chat-user-item{padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer;}
.chat-user-item:hover,.chat-user-item.active{background:rgba(255,215,0,0.15);}
.chat-user-name{color:#ffd700;font-weight:bold;font-size:14px;}
.unread-tag{background:red;color:#fff;font-size:10px;padding:1px 4px;border-radius:4px;margin-left:4px;}
.chat-box{height:420px;display:flex;flex-direction:column;gap:8px;}
.msg-area{flex:1;background:rgba(0,0,0,0.15);border-radius:8px;padding:10px;overflow-y:auto;}
.msg-input-area{display:flex;gap:6px;}
.msg-input{flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid #ffd70055;}
.send-btn{padding:0 16px;background:#ffd700;color:#801010;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
.msg-item{max-width:75%;margin-bottom:10px;padding:8px 12px;border-radius:12px;line-height:1.4;position:relative;}
.msg-me{margin-left:auto;background:#ffd700;color:#5a0000;border-bottom-right-radius:4px;}
.msg-other{margin-right:auto;background:rgba(255,255,255,0.1);color:#fff;border-bottom-left-radius:4px;}
.msg-status{font-size:10px;color:#ccc;text-align:right;margin-top:2px;}

/* è¯­éŸ³ä¼šè®® */
.meeting-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
.meeting-controls{display:flex;gap:8px;}
.meeting-btn{padding:8px 14px;border-radius:6px;border:none;cursor:pointer;}
.meeting-btn.primary{background:#ffd700;color:#5a0000;}
.meeting-btn.secondary{background:rgba(255,255,255,0.1);color:#fff;}
.participant-list{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.participant{background:rgba(255,255,255,0.07);padding:10px;border-radius:8px;text-align:center;}
.part-avatar{width:40px;height:40px;border-radius:50%;background:#ffd700;color:#5a0000;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-weight:bold;}
</style>
</head>
<body>

<!-- å¼€åœº -->
<div class="splash-screen">
  <div class="ntlc-logo">
    <span class="ntlc-letter">N</span>
    <span class="ntlc-letter">T</span>
    <span class="ntlc-letter">L</span>
    <span class="ntlc-letter">C</span>
  </div>
  <p style="color:#666;font-size:20px;">æ–°æ€æƒ³å­¦ä¹ ç¤¾</p>
</div>

<!-- ç™»å½• -->
<div class="auth-modal" id="authModal">
  <div class="auth-box">
    <span class="modal-close" onclick="closeAuth()">Ã—</span>
    <div class="auth-tabs">
      <div class="auth-tab active" data-mode="login">ç™»å½•</div>
      <div class="auth-tab" data-mode="reg">æ³¨å†Œ</div>
    </div>
    <div id="loginForm">
      <input class="auth-input" id="loginAcc" placeholder="è´¦å·">
      <input class="auth-input" id="loginPwd" type="password" placeholder="å¯†ç ">
      <button class="auth-btn" onclick="doLogin()">ç™»å½•</button>
    </div>
    <div id="regForm" style="display:none;">
      <input class="auth-input" id="regAcc" placeholder="è´¦å·">
      <input class="auth-input" id="regPwd" type="password" placeholder="å¯†ç ">
      <input class="auth-input" id="regNick" placeholder="æ˜µç§°">
      <button class="auth-btn" onclick="doReg()">æ³¨å†Œ</button>
    </div>
    <button class="cancel-login" onclick="closeAuth()">æ¸¸å®¢æµè§ˆ</button>
  </div>
</div>

<!-- ä¸»ç•Œé¢ -->
<div class="main-app" id="mainApp">
  <div class="user-bar">
    <div class="user-info">
      <img src="https://picsum.photos/80/80" class="avatar">
      <span class="user-name" id="nickBar"></span>
    </div>
    <span class="logout" onclick="logout()">é€€å‡ºç™»å½•</span>
  </div>

  <!-- æœç´¢ç”¨æˆ·ï¼ˆå…¨å±€æœç´¢æ¡†ï¼‰ -->
  <div class="search-bar">
    <input class="search-input" id="searchInput" placeholder="æœç´¢ç”¨æˆ·ï¼ˆæ˜µç§°/è´¦å·ï¼‰" oninput="doSearch()">
  </div>

  <div class="navbar">
    <h1>æ–°æ€æƒ³å­¦ä¹ ç¤¾</h1>
    <div class="nav-links">
      <span class="nav-link active" onclick="go('home')">é¦–é¡µ</span>
      <span class="nav-link" onclick="go('article')">æœ€æ–°æ–‡ç« </span>
      <span class="nav-link member-only" onclick="go('publish')">å‘å¸ƒæ–‡ç« </span>
      <span class="nav-link member-only" onclick="go('chat')">ç§èŠ</span>
      <span class="nav-link member-only" onclick="go('voice')">è¯­éŸ³ä¼šè®®</span>
      <span class="nav-link admin-only" onclick="go('audit')">æ–‡ç« å®¡æ ¸</span>
      <span class="nav-link root-only" onclick="go('member')">æˆå‘˜ç®¡ç†</span>
      <span class="nav-link" onclick="go('userlist')">ç”¨æˆ·åˆ—è¡¨</span>
    </div>
  </div>

  <div class="container">
    <!-- é¦–é¡µ -->
    <div id="home" class="card">
      <h3>å¹³å°ä»‹ç»</h3>
      <p>æœ¬å¹³å°æ”¯æŒæ–‡ç« å‘å¸ƒå®¡æ ¸ã€ç§èŠï¼ˆå·²è¯»æœªè¯»ï¼‰ã€è¯­éŸ³ä¼šè®®ã€ç”¨æˆ·æœç´¢ã€å¤šçº§ç®¡ç†å‘˜ä½“ç³»ã€‚</p>
    </div>

    <!-- æœ€æ–°æ–‡ç«  -->
    <div id="article" class="card" style="display:none;">
      <h3>æœ€æ–°æ–‡ç« ï¼ˆå·²é€šè¿‡ï¼‰</h3>
      <div id="articleList"></div>
    </div>

    <!-- å‘å¸ƒæ–‡ç«  -->
    <div id="publish" class="card" style="display:none;">
      <h3>å‘å¸ƒæ–‡ç« ï¼ˆéœ€å®¡æ ¸ï¼‰</h3>
      <input class="auth-input" id="artTitle" placeholder="æ ‡é¢˜">
      <textarea class="auth-input" rows="7" id="artContent" placeholder="å†…å®¹"></textarea>
      <button class="auth-btn" onclick="publishArt()">æäº¤å‘å¸ƒ</button>
    </div>

    <!-- ç§èŠ + å·²è¯»æœªè¯» -->
    <div id="chat" class="card" style="display:none;">
      <h3>ç§èŠ</h3>
      <div class="chat-layout">
        <div class="chat-user-list" id="chatUserList"></div>
        <div class="chat-box">
          <div class="msg-area" id="msgArea"></div>
          <div class="msg-input-area">
            <input class="msg-input" id="msgInput" onkeydown="event.key==='Enter'&&sendMsg()">
            <button class="send-btn" onclick="sendMsg()">å‘é€</button>
          </div>
        </div>
      </div>
    </div>

    <!-- è¯­éŸ³ä¼šè®® -->
    <div id="voice" class="card" style="display:none;">
      <h3>è¯­éŸ³ä¼šè®®</h3>
      <div class="meeting-header">
        <div>æˆ¿é—´ï¼š<span id="roomName">æœªåŠ å…¥</span></div>
        <div class="meeting-controls">
          <button class="meeting-btn primary" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
          <button class="meeting-btn secondary" id="micBtn" onclick="toggleMic()">ğŸ¤å¼€å¯éº¦å…‹é£</button>
          <button class="meeting-btn secondary" onclick="leaveRoom()">ç¦»å¼€</button>
        </div>
      </div>
      <div class="participant-list" id="partList"></div>
    </div>

    <!-- æ–‡ç« å®¡æ ¸ï¼ˆç®¡ç†å‘˜+æœ€é«˜ç®¡ç†å¯ç”¨ï¼‰ -->
    <div id="audit" class="card" style="display:none;">
      <h3>æ–‡ç« å®¡æ ¸</h3>
      <div id="auditList"></div>
    </div>

    <!-- æˆå‘˜ç®¡ç†ï¼ˆä»…æœ€é«˜ç®¡ç†ï¼‰ -->
    <div id="member" class="card" style="display:none;">
      <h3>æˆå‘˜æƒé™ç®¡ç†</h3>
      <div id="memberManageList"></div>
    </div>

    <!-- ç”¨æˆ·åˆ—è¡¨ + æœç´¢ç»“æœ -->
    <div id="userlist" class="card" style="display:none;">
      <h3>ç”¨æˆ·åˆ—è¡¨</h3>
      <div id="searchResult"></div>
    </div>
  </div>
</div>

<script>
// é…ç½®
const STORAGE = {users:"ntlc_users", cur:"ntlc_cur", arts:"ntlc_arts", chats:"ntlc_chats", meets:"ntlc_meets"};
const ROOT_ACCOUNT = "17772960463";

// å…¨å±€æ•°æ®
let users = JSON.parse(localStorage.getItem(STORAGE.users)||"[]");
let cur = JSON.parse(localStorage.getItem(STORAGE.cur)||null);
let arts = JSON.parse(localStorage.getItem(STORAGE.arts)||"[]");
let chats = JSON.parse(localStorage.getItem(STORAGE.chats)||"[]");
let meets = JSON.parse(localStorage.getItem(STORAGE.meets)||"[]");

// çŠ¶æ€
let currentRoom = null;
let mic = false;
let stream = null;
let chatTo = null;
let searchResultCache = [];

// å¼€åœºç»“æŸ
setTimeout(()=>{
  document.body.style.overflow="auto";
  cur ? closeAuth() : (document.getElementById("authModal").style.display="flex");
}, 4500);

// ç™»å½•æ³¨å†Œåˆ‡æ¢
document.querySelectorAll(".auth-tab").forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll(".auth-tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const m = t.dataset.mode;
    document.getElementById("loginForm").style.display = m==="login"?"block":"none";
    document.getElementById("regForm").style.display = m==="reg"?"block":"none";
  }
});

// å…³é—­ç™»å½•
function closeAuth(){
  document.getElementById("authModal").style.display="none";
  document.getElementById("mainApp").style.display="block";
  if(!cur){
    document.getElementById("mainApp").classList.remove("has-account","is-admin","is-root");
    document.getElementById("nickBar").innerText="æ¸¸å®¢";
    return;
  }
  document.getElementById("mainApp").classList.add("has-account");
  if(cur.role==="admin"||cur.role==="root") document.getElementById("mainApp").classList.add("is-admin");
  if(cur.role==="root") document.getElementById("mainApp").classList.add("is-root");
  let tag = cur.role==="root"?"ã€æœ€é«˜ç®¡ç†å‘˜ã€‘":cur.role==="admin"?"ã€ç®¡ç†å‘˜ã€‘":"";
  document.getElementById("nickBar").innerText = cur.nick + tag;
}

// æ³¨å†Œ
function doReg(){
  const acc = document.getElementById("regAcc").value.trim();
  const pwd = document.getElementById("regPwd").value.trim();
  const nick = document.getElementById("regNick").value.trim();
  if(!acc||!pwd||!nick) return alert("è¯·å®Œæ•´å¡«å†™");
  if(users.some(u=>u.account===acc)) return alert("è´¦å·å·²å­˜åœ¨");
  let role = "user";
  if(acc===ROOT_ACCOUNT) role="root";
  const u = {uid:"u"+Date.now(), account:acc, pwd:pwd, nick:nick, role:role};
  users.push(u);
  localStorage.setItem(STORAGE.users, JSON.stringify(users));
  alert("æ³¨å†ŒæˆåŠŸ");
  document.querySelector(".auth-tab[data-mode='login']").click();
}

// ç™»å½•
function doLogin(){
  const acc = document.getElementById("loginAcc").value.trim();
  const pwd = document.getElementById("loginPwd").value.trim();
  const u = users.find(x=>x.account===acc&&x.pwd===pwd);
  if(!u) return alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
  cur = u;
  localStorage.setItem(STORAGE.cur, JSON.stringify(cur));
  closeAuth();
}

// é¡µé¢åˆ‡æ¢
function go(page){
  document.querySelectorAll(".card").forEach(c=>c.style.display="none");
  document.getElementById(page).style.display="block";
  document.querySelectorAll(".nav-link").forEach(n=>n.classList.remove("active"));
  document.querySelector(`.nav-link[onclick*="${page}"]`).classList.add("active");
  switch(page){
    case "article": renderArticles(); break;
    case "chat": loadChatUsers(); break;
    case "voice": renderRoom(); break;
    case "audit": renderAudit(); break;
    case "member": renderMemberManage(); break;
    case "userlist": renderAllUsers(); break;
  }
}

// å‘å¸ƒæ–‡ç« 
function publishArt(){
  const t = document.getElementById("artTitle").value.trim();
  const c = document.getElementById("artContent").value.trim();
  if(!t||!c) return alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©º");
  const a = {
    id:"a"+Date.now(), title:t, content:c,
    uid:cur.uid, nick:cur.nick,
    status:"pending", time:new Date().toLocaleString()
  };
  arts.unshift(a);
  localStorage.setItem(STORAGE.arts, JSON.stringify(arts));
  alert("æäº¤æˆåŠŸï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸");
  document.getElementById("artTitle").value="";
  document.getElementById("artContent").value="";
  go("article");
}

// æœ€æ–°æ–‡ç« ï¼ˆä»…é€šè¿‡ï¼‰
function renderArticles(){
  const list = arts.filter(x=>x.status==="pass");
  const el = document.getElementById("articleList");
  el.innerHTML = list.length ? list.map(a=>`
  <div class="article-item">
    <div class="article-title">${a.title}</div>
    <div class="article-meta">${a.nick}ï½œ${a.time}</div>
    <div class="article-content">${a.content}</div>
  </div>
  `).join("") : "<p style='text-align:center;color:#ccc;'>æš‚æ— å·²é€šè¿‡æ–‡ç« </p>";
}

// ====================== æœç´¢ç”¨æˆ· ======================
function doSearch(){
  const kw = document.getElementById("searchInput").value.trim().toLowerCase();
  if(!kw){ renderAllUsers(); return; }
  const res = users.filter(u=>
    u.nick.toLowerCase().includes(kw) ||
    u.account.toLowerCase().includes(kw)
  );
  searchResultCache = res;
  const el = document.getElementById("searchResult");
  el.innerHTML = res.length ? res.map(u=>`
  <div style='padding:10px;border-bottom:1px solid #fff2;'>
    <div style='color:#ffd700;font-weight:bold;'>${u.nick}</div>
    <div style='font-size:12px;color:#ccc;'>è´¦å·ï¼š${u.account}ï½œèº«ä»½ï¼š${u.role==="root"?"æœ€é«˜ç®¡ç†":u.role==="admin"?"ç®¡ç†å‘˜":"æ™®é€š"}</div>
    <button class='btn btn-sm btn-yellow' onclick='openChat("${u.uid}","${u.nick}")'>å‘èµ·ç§èŠ</button>
  </div>
  `).join("") : "<p style='text-align:center;color:#ccc;'>æ— åŒ¹é…ç”¨æˆ·</p>";
  go("userlist");
}
function renderAllUsers(){
  searchResultCache = users.filter(u=>u.uid!==cur?.uid);
  const el = document.getElementById("searchResult");
  el.innerHTML = searchResultCache.length ? searchResultCache.map(u=>`
  <div style='padding:10px;border-bottom:1px solid #fff2;'>
    <div style='color:#ffd700;font-weight:bold;'>${u.nick}</div>
    <div style='font-size:12px;color:#ccc;'>è´¦å·ï¼š${u.account}ï½œèº«ä»½ï¼š${u.role==="root"?"æœ€é«˜ç®¡ç†":u.role==="admin"?"ç®¡ç†å‘˜":"æ™®é€š"}</div>
    <button class='btn btn-sm btn-yellow' onclick='openChat("${u.uid}","${u.nick}")'>å‘èµ·ç§èŠ</button>
  </div>
  `).join("") : "<p style='text-align:center;color:#ccc;'>æš‚æ— å…¶ä»–ç”¨æˆ·</p>";
}

// ====================== ç§èŠ + å·²è¯»æœªè¯» ======================
function loadChatUsers(){
  const list = users.filter(u=>u.uid!==cur.uid);
  const el = document.getElementById("chatUserList");
  el.innerHTML = list.map(u=>{
    const unread = chats.filter(m=>m.from===u.uid&&m.to===cur.uid&&!m.read).length;
    return `
    <div class="chat-user-item" onclick="openChat('${u.uid}','${u.nick}')">
      <div class="chat-user-name">${u.nick} ${unread>0?`<span class="unread-tag">${unread}</span>`:""}</div>
    </div>`;
  }).join("")||"<p style='padding:10px;text-align:center;color:#ccc;'>æ— ç”¨æˆ·</p>";
  document.getElementById("msgArea").innerHTML="<p style='text-align:center;color:#ccc;'>é€‰æ‹©ç”¨æˆ·èŠå¤©</p>";
}
function openChat(uid,nick){
  chatTo = uid;
  document.querySelectorAll(".chat-user-item").forEach(i=>i.classList.remove("active"));
  document.querySelector(`.chat-user-item[onclick*="${uid}"]`).classList.add("active");
  // æ ‡è®°å·²è¯»
  chats.forEach(m=>{
    if(m.from===uid&&m.to===cur.uid) m.read = true;
  });
  localStorage.setItem(STORAGE.chats, JSON.stringify(chats));
  renderMsg();
  loadChatUsers();
}
function renderMsg(){
  if(!chatTo) return;
  const my = cur.uid;
  const to = chatTo;
  const list = chats.filter(m=>
    (m.from===my&&m.to===to)||(m.from===to&&m.to===my)
  );
  const el = document.getElementById("msgArea");
  el.innerHTML = list.map(m=>`
  <div class="msg-item ${m.from===my?'msg-me':'msg-other'}">
    <div>${m.text}</div>
    <div class="msg-status">${m.time}ï½œ${m.read?'å·²è¯»':'æœªè¯»'}</div>
  </div>`).join("");
  el.scrollTop = el.scrollHeight;
}
function sendMsg(){
  const t = document.getElementById("msgInput").value.trim();
  if(!t||!chatTo||!cur) return;
  const msg = {
    from:cur.uid, to:chatTo, text:t,
    time:new Date().toLocaleString(), read:false
  };
  chats.push(msg);
  localStorage.setItem(STORAGE.chats, JSON.stringify(chats));
  document.getElementById("msgInput").value="";
  renderMsg();
  loadChatUsers();
}

// ====================== è¯­éŸ³ä¼šè®® ======================
function createRoom(){
  const n = prompt("æˆ¿é—´å");
  if(!n) return;
  const r = {id:"m"+Date.now(), name:n, creator:cur.uid, users:[cur.uid]};
  meets.push(r); currentRoom = r;
  localStorage.setItem(STORAGE.meets, JSON.stringify(meets));
  renderRoom();
}
function renderRoom(){
  if(!currentRoom){
    document.getElementById("roomName").innerText="æœªåŠ å…¥";
    document.getElementById("partList").innerHTML="<p>æ— å‚ä¼šè€…</p>";
    return;
  }
  document.getElementById("roomName").innerText = currentRoom.name;
  const ps = users.filter(u=>currentRoom.users.includes(u.uid));
  document.getElementById("partList").innerHTML = ps.map(u=>`
  <div class="participant">
    <div class="part-avatar">${u.nick[0]}</div>
    <div>${u.nick}</div>
  </div>`).join("");
}
async function toggleMic(){
  if(!mic){
    try{
      stream = await navigator.mediaDevices.getUserMedia({audio:true});
      mic=true; document.getElementById("micBtn").innerText="ğŸ”‡å…³é—­éº¦å…‹é£";
    }catch(e){alert("éº¦å…‹é£æƒé™è¢«æ‹’ç»");}
  }else{
    stream?.getTracks().forEach(t=>t.stop());
    stream=null; mic=false; document.getElementById("micBtn").innerText="ğŸ¤å¼€å¯éº¦å…‹é£";
  }
}
function leaveRoom(){
  if(!currentRoom) return;
  currentRoom.users = currentRoom.users.filter(u=>u!==cur.uid);
  if(currentRoom.users.length===0) meets = meets.filter(m=>m.id!==currentRoom.id);
  localStorage.setItem(STORAGE.meets, JSON.stringify(meets));
  currentRoom=null; mic=false; stream?.getTracks().forEach(t=>t.stop()); stream=null;
  document.getElementById("micBtn").innerText="ğŸ¤å¼€å¯éº¦å…‹é£";
  renderRoom();
}

// ====================== æ–‡ç« å®¡æ ¸ï¼ˆç®¡ç†å‘˜+æœ€é«˜ç®¡ç†ï¼‰ ======================
function renderAudit(){
  if(!cur||!(cur.role==="root"||cur.role==="admin")){
    alert("ä»…ç®¡ç†å‘˜å¯å®¡æ ¸"); go("home"); return;
  }
  const el = document.getElementById("auditList");
  el.innerHTML = arts.map(a=>`
  <div style='padding:12px;border-bottom:1px solid #fff3;margin-bottom:10px;'>
    <div style='color:#ffd700;font-weight:bold;'>${a.title}</div>
    <div style='font-size:12px;color:#ccc;'>${a.nick}ï½œ${a.time}ï½œ${a.status}</div>
    <div style='margin:8px 0;color:#eee;'>${a.content.substring(0,120)}${a.content.length>120?"...":""}</div>
    <button class='btn btn-sm btn-green' onclick='setArt("${a.id}","pass")'>é€šè¿‡</button>
    <button class='btn btn-sm btn-red' onclick='setArt("${a.id}","reject")'>é©³å›</button>
  </div>
  `).join("")||"<p>æš‚æ— æ–‡ç« </p>";
}
function setArt(aid,s){
  const a = arts.find(x=>x.id===aid);
  if(!a) return;
  a.status = s;
  localStorage.setItem(STORAGE.arts, JSON.stringify(arts));
  renderAudit();
}

// ====================== æˆå‘˜ç®¡ç†ï¼ˆä»…æœ€é«˜ç®¡ç†ï¼‰ ======================
function renderMemberManage(){
  if(!cur||cur.role!=="root"){alert("ä»…æœ€é«˜ç®¡ç†å‘˜");go("home");return;}
  const el = document.getElementById("memberManageList");
  el.innerHTML = users.map(u=>`
  <div style='padding:10px;border-bottom:1px solid #fff2;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;'>
    <div>
      <span style='color:#ffd700;font-weight:bold;'>${u.nick}</span>
      <span style='font-size:12px;color:#ccc;margin-left:6px;'>${u.account}</span>
      <span style='background:#ffd700;color:#801010;padding:2px 6px;border-radius:4px;font-size:12px;margin-left:6px;'>${u.role}</span>
    </div>
    <div>
      ${u.role!=="root"?`
      <button class='btn btn-sm btn-yellow' onclick='setRole("${u.uid}","admin")'>è®¾ç®¡ç†å‘˜</button>
      <button class='btn btn-sm btn-gray' onclick='setRole("${u.uid}","user")'>å–æ¶ˆç®¡ç†</button>
      `:""}
      <button class='btn btn-sm btn-red' onclick='delUser("${u.uid}")'>åˆ é™¤</button>
    </div>
  </div>
  `).join("");
}
function setRole(uid,role){
  const u = users.find(x=>x.uid===uid);
  if(!u||u.role==="root") return;
  u.role = role;
  localStorage.setItem(STORAGE.users, JSON.stringify(users));
  renderMemberManage();
}
function delUser(uid){
  const u = users.find(x=>x.uid===uid);
  if(!u||u.role==="root") return alert("æ— æ³•åˆ é™¤æœ€é«˜ç®¡ç†å‘˜");
  if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
  users = users.filter(x=>x.uid!==uid);
  localStorage.setItem(STORAGE.users, JSON.stringify(users));
  renderMemberManage();
}

// é€€å‡ºç™»å½•
function logout(){
  cur = null;
  localStorage.removeItem(STORAGE.cur);
  stream?.getTracks().forEach(t=>t.stop());
  stream = null; mic = false; currentRoom = null;
  document.getElementById("authModal").style.display="flex";
  document.getElementById("mainApp").style.display="none";
  document.getElementById("mainApp").classList.remove("has-account","is-admin","is-root");
}
</script>
</body>
</html>
